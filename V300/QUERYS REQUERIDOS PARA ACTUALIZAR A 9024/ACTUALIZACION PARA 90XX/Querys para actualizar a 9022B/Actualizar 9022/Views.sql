-- ******************* SAINT ANNUAL ENTERPRISE AUTOMOTRIZ **********************-- ******************* PROCEDURE PARA VERSION 9039  ****************************-- SCRIPTS REALIZADO POR: JOSE RAVELO / ENERO 2019 --         TESTEADO: POR: JOSE RAVELO / ENERO 2019--         EJECUTADO: -- Corrige y genera VW para SP_Master_Transact  -- *****************************************************************************IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_INSTAPROD' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_INSTAPROD;
GO
Create View dbo.VW_ADM_INSTAPROD AS  WITH CTEInsta AS (SELECT CodInst, InsPadre, Descrip, 0 AS HLevel,         CAST(RIGHT(REPLICATE('0',4)+CONVERT(VARCHAR(4),CodInst),4) AS VARCHAR(MAX)) AS OrderByField    FROM VW_SAINSTA WITH (NOLOCK)   WHERE (InsPadre=0) AND (TIPOINS=0)   UNION ALL  SELECT C.CodInst, C.InsPadre, C.Descrip,         (CTE.HLevel+1) AS HLevel,         CTE.OrderByField+         CAST(RIGHT(REPLICATE('0',4)+CONVERT(VARCHAR(4),C.CodInst),4) AS VARCHAR(MAX)) AS OrderByField    FROM VW_SAINSTA C WITH (NOLOCK)   INNER JOIN CTEInsta CTE ON         CTE.CodInst=C.InsPadre   WHERE (C.InsPadre IS NOT NULL) AND (C.TIPOINS=0)) SELECT C.CodInst,C.InsPadre,C.Descrip,        I.Descto,I.DEsComp,I.DEsSeri,I.DEsLote,        I.DEsComi,I.DEsCorrel,I.DigitosC,I.Nivel,I.DEsTabla,I.TipoIns,        C.HLevel, C.OrderByField   FROM CTEInsta C WITH (NOLOCK)  INNER JOIN VW_SAINSTA I ON        I.CODINST=C.CODINST
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_INSTASERV' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_INSTASERV;
GO
Create View dbo.VW_ADM_INSTASERV AS  WITH CTEInsta AS (SELECT CodInst, InsPadre, Descrip, 0 AS HLevel,         CAST(RIGHT(REPLICATE('0',4)+CONVERT(VARCHAR(4),CodInst),4) AS VARCHAR(MAX)) AS OrderByField    FROM VW_SAINSTA WITH (NOLOCK)   WHERE (InsPadre=0) AND (TIPOINS=1)   UNION ALL  SELECT C.CodInst, C.InsPadre, C.Descrip,         (CTE.HLevel+1) AS HLevel,         CTE.OrderByField+         CAST(RIGHT(REPLICATE('0',4)+CONVERT(VARCHAR(4),C.CodInst),4) AS VARCHAR(MAX)) AS OrderByField    FROM VW_SAINSTA C WITH (NOLOCK)   INNER JOIN CTEInsta CTE ON         CTE.CodInst=C.InsPadre   WHERE (C.InsPadre IS NOT NULL) AND (C.TIPOINS=1)) SELECT C.CodInst,C.InsPadre,C.Descrip,        I.Descto,I.DEsComp,I.DEsSeri,I.DEsLote,        I.DEsComi,I.DEsCorrel,I.DigitosC,I.Nivel,I.DEsTabla,I.TipoIns,        C.HLevel, C.OrderByField   FROM CTEInsta C WITH (NOLOCK)  INNER JOIN VW_SAINSTA I ON        I.CODINST=C.CODINST
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_PRODUCTOS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_PRODUCTOS;
GO
CREATE VIEW dbo.VW_ADM_PRODUCTOS AS SELECT P.CodProd, P.Descrip, P.Descrip2, P.Descrip3, P.Descrip+IsNull(' '+P.Descrip2,'')+IsNull(' '+P.Descrip3,'') As DescripAll, (CASE SUBSTRING(P.DESCRIP,1,1) WHEN '?' THEN 1 ELSE 0 END) AS ESFREEP, P.Precio1, P.Precio2, P.Precio3, P.Preciou2, P.Preciou3, P.Refere, P.Marca, P.Unidad, P.ACTIVO, P.UndEmpaq, P.CantEmpaq, P.PrecioU, P.CostAct, P.CostPro, P.CostAnt, P.Peso, P.Volumen, P.UndVol, P.Existen, P.ExUnidad, P.Compro, P.Pedido, P.Minimo, P.Maximo, P.DEsVence, P.EsPesa, P.Tara,P.EsImport, P.EsExento, P.EsEnser, P.EsEmpaque, P.ExDecimal, I.Descto, P.DEsComp, P.DEsSeri, P.DEsLote, I.DEsComi, I.DEsCorrel, I.DigitosC, I.CodInst FROM SAPROD P WITH (NOLOCK) INNER JOIN SAINSTA I ON P.CodInst=I.CodInst
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_EXISTENCIA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_EXISTENCIA;
GO
CREATE VIEW DBO.VW_ADM_EXISTENCIA AS SELECT EX.CODPROD, EX.CODUBIC, SD.DESCRIP,  EX.EXISTEN, EX.EXUNIDAD, EX.PUESTOI, EX.CANTCOM, EX.UNIDCOM, EX.CANTPED, EX.UNIDPED FROM SAEXIS EX WITH (NOLOCK) LEFT JOIN SADEPO SD ON      EX.CODUBIC=SD.CODUBIC WHERE EX.CODUBIC=SD.CODUBIC
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_EQUIVALENTES' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_EQUIVALENTES;
GO
CREATE VIEW DBO.VW_ADM_EQUIVALENTES AS SELECT SAEQUI.CodProd AS CodAlte, SAEQUI.CodAlte AS Codprod, SAPROD.Descrip FROM SAEQUI  WITH (NOLOCK) INNER JOIN SAPROD ON SAEQUI.CodProd = SAPROD.CodProd
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_PARTES' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_PARTES;
GO
CREATE VIEW DBO.VW_ADM_PARTES AS SELECT PA.CODPROD, PA.CODALTE, PA.CANTIDAD, PA.ESUNID, PA.ESSERV, PA.NROUNICO,     (CASE WHEN PA.ESSERV=0 THEN PR.CODINST   ELSE SR.CODINST  END) AS CODINST,     (CASE WHEN PA.ESSERV=0 THEN PR.DESCRIP   ELSE SR.DESCRIP  END) AS DESCRIP,     (CASE WHEN PA.ESSERV=0 THEN PR.DESCRIP2  ELSE SR.DESCRIP2 END) AS DESCRIP2,     (CASE WHEN PA.ESSERV=0 THEN PR.DESCRIP3  ELSE SR.DESCRIP3 END) AS DESCRIP3,     (CASE WHEN PA.ESSERV=0 THEN PR.ESEMPAQUE ELSE 0           END) AS ESEMPAQUE,     (CASE WHEN PA.ESSERV=0 THEN PR.CANTEMPAQ ELSE 0           END) AS CANTEMPAQ,     (CASE WHEN PA.ESSERV=0 THEN PR.DESVENCE  ELSE 0           END) AS DESVENCE,     (CASE WHEN PA.ESSERV=0 THEN PR.COSTACT   ELSE SR.COSTO    END) AS COSTACT,     (CASE WHEN PA.ESSERV=0 THEN PR.COSTPRO   ELSE SR.COSTO    END) AS COSTPRO,     (CASE WHEN PA.ESSERV=0 THEN PR.COSTANT   ELSE SR.COSTO    END) AS COSTANT,     (CASE WHEN PA.ESSERV=0 THEN 0            ELSE SR.ESPORCOST END)AS ESPORCOST,     (CASE WHEN PA.ESSERV=0 THEN PR.PRECIO1   ELSE SR.PRECIO1 END) AS PRECIO1,     (CASE WHEN PA.ESSERV=0 THEN PR.PRECIO2   ELSE SR.PRECIO2 END) AS PRECIO2,     (CASE WHEN PA.ESSERV=0 THEN PR.PRECIO3   ELSE SR.PRECIO3 END) AS PRECIO3,     (CASE WHEN PA.ESSERV=0 THEN PR.PRECIOU   ELSE 0 END) AS PRECIOU1,     (CASE WHEN PA.ESSERV=0 THEN PR.PrecioU2  ELSE 0 END) AS PRECIOU2,     (CASE WHEN PA.ESSERV=0 THEN PR.PrecioU3  ELSE 0 END) AS PRECIOU3,     (CASE WHEN PA.ESSERV=0 THEN PR.DEsSeri   ELSE 0 END) AS DESSERI,     (CASE WHEN PA.ESSERV=0 THEN PR.REFERE    ELSE SR.CLASE END) AS REFERE,     (CASE WHEN PA.ESSERV=0 THEN PR.DESLOTE   ELSE 0 END) AS DESLOTE,     (CASE WHEN PA.ESSERV=0 THEN PR.ESPESA    ELSE 0 END) AS ESPESA,     (CASE WHEN PA.ESSERV=0 THEN PR.TARA      ELSE 0 END) AS TARA,     (CASE WHEN PA.ESSERV=0 THEN 0            ELSE SR.USASERV END) AS USASERV,     (CASE WHEN PA.ESSERV=0 THEN PR.UNIDAD    ELSE SR.UNIDAD END) AS UNIDAD,     (CASE WHEN PA.ESSERV=0 THEN PR.UNDEMPAQ  ELSE NULL END) AS UNDEMPAQ,     (CASE WHEN PA.ESSERV=0 THEN PR.EXDECIMAL ELSE 0 END) AS EXDECIMAL  FROM SAPART PA       LEFT JOIN SAPROD PR ON         PA.CODALTE=PR.CODPROD       LEFT JOIN SASERV SR ON         PA.CODALTE=SR.CODSERV
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_PROVINVENT' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_PROVINVENT;
GO
CREATE VIEW DBO.VW_ADM_PROVINVENT AS SELECT SE.CODITEM, SE.CODPROV,       PV.DESCRIP AS DESCRPROV,        (CASE WHEN SE.ESSERV=0 THEN PR.DESCRIP ELSE SR.DESCRIP END) AS DESCRIP,       (CASE WHEN SE.ESSERV=0 THEN PR.REFERE  ELSE SR.CLASE   END) AS REFERE,       SE.FECHAE, SE.COSTO, SE.CANTIDAD, SE.NUMEROD, SE.NROUNICO   FROM SAPVPR SE WITH (NOLOCK) INNER JOIN SAPROV PV ON       PV.CODPROV=SE.CODPROV  LEFT JOIN SAPROD PR ON       PR.CODPROD=SE.CODITEM  LEFT JOIN SASERV SR ON       SR.CODSERV=SE.CODITEM
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_CLIEINVENT' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_CLIEINVENT;
GO
CREATE VIEW DBO.VW_ADM_CLIEINVENT AS SELECT SE.CODITEM, F.CODCLIE,       F.DESCRIP AS DESCRCLIE,        (CASE WHEN SE.ESSERV=0 THEN PR.DESCRIP ELSE SR.DESCRIP END) AS DESCRIP,       (CASE WHEN SE.ESSERV=0 THEN PR.REFERE  ELSE SR.CLASE   END) AS REFERE,       F.FECHAE, SE.PRECIO, SE.CANTIDAD, SE.NUMEROD   FROM SAITEMFAC SE WITH (NOLOCK) INNER JOIN SAFACT F ON        F.TIPOFAC=SE.TIPOFAC AND F.NUMEROD=SE.NUMEROD   LEFT JOIN SAPROD PR ON       PR.CODPROD=SE.CODITEM  LEFT JOIN SASERV SR ON       SR.CODSERV=SE.CODITEM
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_TAXINVENT' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_TAXINVENT;
GO
CREATE VIEW dbo.VW_ADM_TAXINVENT AS SELECT SE.CODPROD, SE.CODTAXS, SD.DESCRIP, SD.ESPORCT, SE.MONTO, SD.ESLIBROI, SD.ESFIJO, SD.ESTAXVENTA, SD.ESTAXCOMPRA, SD.ESRETEN, SD.CODOPER, SD.SUSTRAENDO FROM SATAXPRD SE, SATAXES SD WITH (NOLOCK) WHERE SE.CODTAXS=SD.CODTAXS
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_TAXSERVI' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_TAXSERVI;
GO
CREATE VIEW dbo.VW_ADM_TAXSERVI AS SELECT SE.CODSERV, SE.CODTAXS, SD.DESCRIP, SD.ESPORCT, SE.MONTO, SD.ESLIBROI, SD.ESFIJO, SD.ESTAXVENTA, SD.ESTAXCOMPRA, SD.ESRETEN, SD.CODOPER, SD.SUSTRAENDO FROM SATAXSRV SE, SATAXES SD WITH (NOLOCK) WHERE SE.CODTAXS=SD.CODTAXS
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_SERVICIOS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_SERVICIOS;
GO
CREATE VIEW dbo.VW_ADM_SERVICIOS AS SELECT S.CodServ, S.Descrip, S.Descrip2, S.Descrip3,S.Descrip+IsNull(' '+S.Descrip2,'')+IsNull(' '+S.Descrip3,'') As DescripAll, (CASE SUBSTRING(S.DESCRIP,1,1) WHEN '?' THEN 1 ELSE 0 END) AS ESFREEP, S.Precio1, S.Precio2, S.Precio3,S.ESIMPORT, S.ACTIVO, s.EsVenta, s.EsCompra,S.Unidad, S.Clase, S.Costo, S.EsExento, I.CodInst, I.Descto,S.EsPorCost, S.usaServ, S.comision, S.esporcomi, S.fechauv, S.fechauc FROM SASERV S WITH (NOLOCK) INNER JOIN SAINSTA I ON S.CodInst = I.CodInst
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_FACTURAS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_FACTURAS;
GO
CREATE VIEW DBO.VW_ADM_FACTURAS AS SELECT Tipofac, Numerod,NroCtrol, CodSucu, CodEsta,CodUsua, NumeroC, Signo,NumeroF, NumeroP, CodClie, CodVend,CodUbic, Descrip, Direc1, Direc2,Direc3, ZipCode,Telef, ID3, DetalChq, FechaT,FechaE, FechaV, OrdenC,  CodOper,  NGiros, NMeses,Signo*Monto As Monto,Signo*MtoTotal as MontoTotal,Signo*MtoTax As MtoTax, Signo*Fletes As Fletes,Signo*(TGravable-TGravable*(Descto1+Descto2)/100) As TGravable,Signo*(TExento-TExento*(Descto1+Descto2)/100+Fletes*(SELECT (case when IMPFLETEV=0 then 1 else 0 end)         FROM SACONF WHERE CODSUCU='00000')) As TExento,Signo*CostoPrd As CostoPrd, Signo*CostoSrv As CostoSrv,Signo*DesctoP  As DesctoP, Signo*RetenIVA As RetenIVA,Signo*CancelI  As CancelI, Signo*CancelA As CancelA,Signo*CancelE  As CancelE, Signo*CancelC As CancelC,Signo*CancelT  As CancelT, Signo*CancelG As CancelG,Signo*Cambio   As Cambio, Signo*MtoExtra As MtoExtra,Signo*Descto1  As Descto1, Signo*Descto2 As Descto2,Signo*TotalPrd As TotalPrd, Signo*TotalSrv As TotalSrv,Signo*MtoComiVta As MtoComiVta, Signo*MtoComiCob As MtoComiCob,Signo*MtoComiVtaD As MtoComiVtaD, Signo*MtoComiCobD As MtoComiCobD,Signo*MtoFinanc As MtoFinanc,Signo*(MtoComiVta+MtoComiVtaD) As TotMtoComiVta,Signo*(MtoComiCob+MtoComiCobD) As TotMtoComiCob,Signo*(Monto-(Descto1+Descto2)+MtoTax+Fletes) As Monto_Bruto,Signo*(Monto-(Descto1+Descto2)) As Monto_Neto,Signo*(Descto1+Descto2) As Monto_Descto,Signo*(Costoprd+CostoSrv) As Monto_Costo,Signo*(Contado) As Contado,Signo*(Credito) As Credito,Signo*(Monto-(Descto1+Descto2)-(CostoPrd+CostoSrv)) As Monto_Utili, (Case (Monto-(Descto1+Descto2))       When 0  Then 0       Else Signo*(Monto-(Descto1+Descto2)-(CostoPrd+CostoSrv))/                  (Monto-(Descto1+Descto2))*100  End) As Monto_PorUtil,(Case (Monto-(Descto1+Descto2))       When 0  Then 0       Else (Case (MtoComiVta+MtoComiVtaD) When 0 Then 0                   else Signo*(Monto-(Descto1+Descto2)-(MtoComiVta+MtoComiVtaD))/                         (Monto-(Descto1+Descto2))*100             End)  End) As Monto_PorComi, (Case Contado        When 0  Then 0       Else (Case (MtoComiCob+MtoComiCobD) When 0 Then 0                   else Signo*(Contado-(MtoComiCob+MtoComiCobD))/Contado*100             End)  End) As Monto_PorComiCob, Notas1, Notas2, Notas3, Notas4, Notas5, Notas6, Notas7, Notas8, Notas9, Notas10 From SAFACT WITH (NOLOCK) Where TipoFac in ('A','B')
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_ITEMSFACTURA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_ITEMSFACTURA;
GO
Create View dbo.VW_ADM_ITEMSFACTURA AS Select it.CodSucu, it.TipoFac, it.NumeroD, it.coditem, it.signo,       (case when it.esserv=0 then pr.codinst else sr.codinst end) as CodInst,       it.Descrip1, it.Descrip2,it.Descrip3, it.Descrip4, it.Descrip5,        it.Descrip6, it.Descrip7, it.Descrip8,it.Descrip9, it.Descrip10,        it.nrolinea, it.nrolineac, it.EsServ,       F.CodOper,F.CodClie,F.CodVend,F.CodUsua,F.CodEsta,it.CodMeca,        F.Signo*it.priceO as PriceO, F.Signo*it.mtoTax As MtoTax, F.Signo*it.precio as Precio,       F.Signo*it.Cantidad*(IT.Precio-ISNULL((F.Descto1+F.Descto2)*IT.Precio/NULLIF(F.Monto,0),0)) as TotPrecio,       F.Signo*IT.Cantidad*((IT.Precio-ISNULL((F.Descto1+F.Descto2)*IT.Precio/NULLIF(F.Monto,0),0))-IT.Costo) as Utilidad,       it.EsUnid, it.DEsComp, it.EsExento, it.CantMayor, F.Signo*it.Cantidad As Cantidad,       it.CantidadA, it.codUbic, it.nroUnicoL, It.Descto,       F.Signo*it.Costo As Costo, F.Signo*It.Cantidad*it.Costo As TotCosto, ISNULL(it.NroLote,'') As NroLote,       it.fechaL, it.Fechav AS FechaVL, F.FechaE AS FechaEF, F.Fechav  AS FechaVF,       (CASE SUBSTRING((Case when it.esserv=0 Then PR.DESCRIP else sr.descrip end),1,1) WHEN '?' THEN 1 ELSE 0 END) AS ESFREEP,       (Case when it.esserv=0 Then           (case it.esunid When 0 Then pr.Existen Else pr.ExUnidad End)        Else 0 End) as ExActual,    (Case when it.esserv=0 Then pr.DEsLote else 0 end) As DEsLote,    (Case when it.esserv=0 Then pr.DEsSeri else 0 end) As DEsSeri,    (Case when it.esserv=0 Then Pr.DEsVence else 0 end) As DEsVence,    (Case when it.esserv=0 Then pr.EsPesa else 0 end) As EsPesa,    (Case when it.esserv=0 Then pr.tara else 0 end) As Tara,    (Case when it.esserv=0 Then pr.Unidad else sr.Unidad end) As Unidad,    (Case when it.esserv=0 Then pr.undempaq else '' end) As UndEmpaq,    (Case when it.esserv=0 Then pr.cantempaq else 0 end) As CantEmpaq,    (Case when it.esserv=0 Then pr.exdecimal else 0 end) As ExDecimal,    (Case when it.esserv=0 Then pr.refere else sr.clase end) As Refere,    (Case when it.esserv=0 Then pr.precio1 else sr.precio1 end) As Precio1,    (Case when it.esserv=0 Then pr.precio2 else sr.precio2 end) As Precio2,    (Case when it.esserv=0 Then pr.precio3 else sr.precio3 end) As Precio3,    (Case when it.esserv=0 Then Pr.precioU else 0 end) As PrecioU,    (Case when it.esserv=0 Then PR.Preciou2 else 0 end) As PrecioU2,    (Case when it.esserv=0 Then PR.Preciou3 else 0 end) As PrecioU3,    (Case when it.esserv=0 Then PR.Peso else 0 end) As Peso,    (Case when it.esserv=0 Then PR.Volumen else 0 end) As Volumen,    (Case when it.esserv=0 Then PR.UndVol else '' end) As UndVol,    (Case when it.esserv=0 Then pr.costpro else sr.costo end) As CostPro,    (Case when it.esserv=0 Then pr.costAct else sr.costo end) As CostAct,    (Case when it.esserv=0 Then pr.esImport else sr.EsImport end) As EsImport,    (Case when it.esserv=0 Then 0 else sr.UsaServ end) As UsaServ  FROM saitemfac it WITH (NOLOCK) INNER JOIN SAFACT F ON   (it.codSucu=f.codsucu) And (F.TIPOFAC=IT.TIPOFAC) AND (F.NUMEROD=IT.NUMEROD) left join saprod pr on    it.coditem=pr.codprod left join saserv sr on    it.coditem=sr.codserv
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_COMPRAS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_COMPRAS;
GO
CREATE VIEW DBO.VW_ADM_COMPRAS AS SELECT TipoCOM, Numerod,       NroCtrol, CodSucu, CodEsta,       CodUsua, NumeroC, Signo,       NumeroP, CodProv,       CodUbic, Descrip, Direc1, Direc2,       Telef, ID3, DetalChq, FechaT,       FechaE, FechaV, OrdenC,  CodOper,  NGiros, NMeses,       Signo*Monto As Monto,       Signo*MtoTotal as MontoTotal,       Signo*MtoTax As MtoTax, Signo*Fletes As Fletes,       Signo*(TGravable-TGravable*(Descto1+Descto2)/100) As TGravable,       Signo*(TExento  -TExento  *(Descto1+Descto2)/100) As TExento,       Signo*DesctoP  As DesctoP, Signo*RetenIVA As RetenIVA,       Signo*CancelI  As CancelI, Signo*CancelA As CancelA,       Signo*CancelE  As CancelE, Signo*CancelC As CancelC,       Signo*CancelT  As CancelT, Signo*CancelG As CancelG,       Signo*Descto1  As Descto1, Signo*Descto2 As Descto2,       Signo*TotalPrd As TotalPrd, Signo*TotalSrv As TotalSrv,       Signo*MtoFinanc As MtoFinanc,       Signo*(Monto-(Descto1+Descto2)+MtoTax+Fletes) As Monto_Bruto,       Signo*(Monto-(Descto1+Descto2)) As Monto_Neto,       Signo*(Descto1+Descto2) As Monto_Descto,       Signo*(Contado) As Contado,       Signo*(Credito) As Credito,       Notas1, Notas2, Notas3, Notas4, Notas5, Notas6,       Notas7, Notas8, Notas9, Notas10  From VW_SACOMP WITH (NOLOCK) Where TipoCOM in ('H','I')
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_ITEMSCOMPRA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_ITEMSCOMPRA;
GO
create view dbo.VW_ADM_ITEMSCOMPRA AS Select IT.codSucu, it.TipoCom, it.NumeroD, it.codprov, it.coditem, c.signo, it.Descrip1, it.Descrip2,   it.Descrip3, it.Descrip4, it.Descrip5, it.Descrip6,   it.Descrip7, it.Descrip8, it.Descrip9, it.Descrip10,   it.precio, it.precioU, it.nrolinea, it.NroUnicoL, it.EsServ, it.EsUnid,   it.EsExento, it.Cantidad, it.CantidadA, c.Signo*it.cantidad*it.Costo as TotCosto, it.codUbic, it.NroLote,   it.costo, it.fechaL, it.Fechav AS FechaVL, C.FechaE  AS FechaEC, C.Fechav  AS FechaVC,    it.Precio1 As OPrecio1, it.Precio2 As OPrecio2,   it.Precio3 As OPrecio3, it.faltante, it.descto,   ip.DocImpo, ip.FechaI, ip.Factor,it.MtoTax, it.CostOrg,   ip.costo1, ip.costo2, ip.costo3, ip.costo4, ip.costo5,   ip.costo6, ip.costo7, ip.costo8, ip.costo9, ip.costo10,   ip.precioU As PrecioIU1, ip.precioU2 As PrecioIU2, ip.precioU3 As PrecioIU3,   ip.precio1 As PrecioI1, ip.precio2  As PrecioI2,  ip.precio3 As PrecioI3,   (CASE SUBSTRING((Case when it.esserv=0 Then PR.DESCRIP else sr.descrip end),1,1)           WHEN '?' THEN 1 ELSE 0 END) AS ESFREEP,   (case when it.esserv=0 then        isnull((select codinst from sainsta where pr.codinst=codInst),0)    else        isnull((select codinst from sainsta where sr.codinst=codInst),0)    end) as CodInst,   (case when it.esserv=0 then pr.EsImport   else 0 end) As EsImport,   (case when it.esserv=0 then pr.DEsSeri   else 0 end) As DEsSeri,   (Case when it.esserv=0 Then pr.DEsLote   else 0 end) As DEsLote,   (case when it.esserv=0 then Pr.DEsVence  else 0 end) As DEsVence,   (case when it.esserv=0 then pr.EsPesa    else 0 end) As EsPesa,   (case when it.esserv=0 then pr.tara      else 0 end) As Tara,   (case when it.esserv=0 then pr.undempaq  else '' end) As UndEmpaq,   (case when it.esserv=0 then pr.Unidad    else sr.unidad end) As Unidad,   (case when it.esserv=0 then pr.cantempaq else 0 end) As CantEmpaq,   (case when it.esserv=0 then pr.exdecimal else 0 end) As ExDecimal,   (case when it.esserv=0 then pr.refere    else sr.clase end) As Refere,   (case when it.esserv=0 then pr.costpro   else sr.costo end) As CostPro,   (case when it.esserv=0 then pr.costAct   else sr.costo end) As CostAct,   (case when it.esserv=0 then 0            else sr.UsaServ end) As UsaServ,   (case when it.esserv=0 then pr.precio1   else sr.precio1 end) As Precio1,   (case when it.esserv=0 then pr.precio2   else sr.precio2 end) As Precio2,   (case when it.esserv=0 then pr.precio3   else sr.precio3 end) As Precio3,   (case when it.esserv=0 then Pr.precioU   else 0 end) As PrecioU1,   (case when it.esserv=0 then PR.Preciou2  else 0 end) As PrecioU2,   (case when it.esserv=0 then PR.Preciou3  else 0 end) As PrecioU3,   (case when it.esserv=0 then PR.Peso      else 0 end) As Peso,   (case when it.esserv=0 then PR.Volumen   else 0 end) As Volumen,   (case when it.esserv=0 then PR.UndVol    else '' end) As UndVol  from SAITEMCOM it WITH (NOLOCK)   inner Join VW_ADM_COMPRAS C on      (c.codSucu=it.codsucu) And (c.tipocom=it.tipocom) and       (c.numerod=it.numerod) and (c.codprov=it.codprov)   left Join saprimcom ip on      (ip.codSucu=it.codsucu) And (ip.tipocom=it.tipocom) and      (ip.numerod=it.numerod) and (ip.codprov=it.codprov) and      (ip.nrolinea=it.nrolinea)   LEFT join saprod pr on      it.coditem=pr.codprod   LEFT join saServ sr on      it.coditem=sr.codServ
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_MOVSERVICIOS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_MOVSERVICIOS;
GO
CREATE VIEW DBO.VW_ADM_MOVSERVICIOS AS SELECT PERIODO,CODSERV,CODINST,INSTDESCRIP,       SUM(CASE WHEN A.TIPO IN ('A','B') THEN A.COSTO ELSE 0 END) AS MTOCOSTVENTAS,        SUM(CASE WHEN A.TIPO IN ('A','B') THEN A.TOTPRECIO ELSE 0 END) AS MTOVENTAS,        SUM(CASE WHEN A.TIPO IN ('H','I') THEN A.COSTO ELSE 0 END) AS MTOCOSTCOMPRAS,       SUM(UTILIDAD) AS MTOUTILIDAD  FROM    (SELECT         SI.CODITEM AS CODSERV,         SI.TIPOFAC AS TIPO,         I.CODINST,        I.DESCRIP AS INSTDESCRIP,        YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,        SUM(S.SIGNO*SI.CANTIDAD*SI.CANTMAYOR) AS CANTIDAD,         SUM(S.SIGNO*SI.CANTIDAD*SI.CANTMAYOR*SI.COSTO) AS COSTO,        SUM(CASE S.MONTO WHEN 0 THEN S.SIGNO*SI.CANTIDAD*SI.PRECIO             ELSE S.SIGNO*SI.CANTIDAD*(SI.PRECIO -(S.DESCTO1+S.DESCTO2)*SI.PRECIO/S.MONTO)          END) AS TOTPRECIO,        SUM(CASE S.MONTO WHEN 0 THEN S.SIGNO*SI.CANTIDAD*(SI.PRECIO -SI.COSTO)             ELSE S.SIGNO*SI.CANTIDAD*((SI.PRECIO -(S.DESCTO1+S.DESCTO2)*SI.PRECIO/S.MONTO)-SI.COSTO)          END) AS UTILIDAD       FROM SAFACT AS S JOIN             SAITEMFAC AS SI ON (s.codSucu=si.codsucu) And (S.TIPOFAC=SI.TIPOFAC) AND  (S.NUMEROD=SI.NUMEROD)             JOIN SASERV AS P ON (SI.CODITEM=P.CODSERV)             JOIN SAINSTA AS I ON (P.CODINST=I.CODINST)       WHERE (SI.DESCOMP= 0) AND (SI.TIPOFAC IN ('A','B','C','D'))       GROUP BY  SI.CODITEM,SI.TIPOFAC,YEAR(S.FECHAE)*100+MONTH(S.FECHAE),I.CODINST,I.DESCRIPUNION ALL     SELECT       SI.CODITEM,       SI.TIPOCOM AS TIPO,       I.CODINST,      I.DESCRIP AS INSTDESCRIP,      YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,      SUM(S.SIGNO*SI.CANTIDAD) AS CANTIDAD,       SUM(S.SIGNO*SI.CANTIDAD*SI.COSTO) AS COSTO,      0.0 AS TOTPRECIO,      0.0 AS UTILIDAD      FROM SACOMP AS S JOIN             SAITEMCOM AS SI ON (S.codSucu=SI.codsucu) And (S.TIPOCOM=SI.TIPOCOM) AND  (S.NUMEROD=SI.NUMEROD) AND  (S.NUMEROD=SI.NUMEROD) AND  (S.CODPROV=SI.CODPROV)             JOIN SASERV AS P ON (SI.CODITEM=P.CODSERV)            JOIN SAINSTA AS I ON (P.CODINST=I.CODINST)        WHERE  (SI.TIPOCOM IN ('H','I','J','K'))       GROUP BY  SI.CODITEM, SI.TIPOCOM,YEAR(S.FECHAE)*100+MONTH(S.FECHAE),I.CODINST,I.DESCRIP     ) A GROUP BY PERIODO,CODSERV,CODINST,INSTDESCRIP
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_MOVPRODUCTOS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_MOVPRODUCTOS;
GO
CREATE VIEW DBO.VW_ADM_MOVPRODUCTOS AS SELECT PERIODO,CODPROD,CODINST,INSTDESCRIP,(SELECT SUM(I.EXINICIAL)+(SUM(I.EXUNDINI)/(CASE WHEN A.CANTEMPAQ=0 THEN 1 ELSE A.CANTEMPAQ END)) FROM SAINITI I WHERE I.CODPROD=A.CODPROD  AND I.PERIODO=A.PERIODO)*(SELECT TOP 1 I.COSTO FROM SAINITI I WHERE I.CODPROD=A.CODPROD  AND I.PERIODO=A.PERIODO) AS MTOCOSTEXINICIAL,SUM(CASE WHEN A.TIPO IN ('A','B') THEN A.COSTO ELSE 0 END) AS MTOCOSTVENTAS,SUM(CASE WHEN A.TIPO IN ('H','I') THEN A.COSTO ELSE 0 END) AS MTOCOSTCOMPRAS,SUM(CASE WHEN A.TIPO ='O' THEN A.COSTO ELSE 0 END) AS MTOCOSTCARGOS,SUM(CASE WHEN A.TIPO ='P' THEN A.COSTO ELSE 0 END) AS MTOCOSTDESCARGOS,SUM(UTILIDAD) AS MTOUTILIDAD,(SELECT SUM(I.EXISTEN)+(SUM(I.EXUNIDAD)/(CASE WHEN A.CANTEMPAQ=0 THEN 1 ELSE A.CANTEMPAQ END)) FROM SAEXIS I WHERE I.CODPROD=A.CODPROD)*A.COSTPRO AS MTOCOSTEXFINALACT,(SELECT SUM(I.EXFINAL)+(SUM(I.EXUNDFINAL)/(CASE WHEN A.CANTEMPAQ=0 THEN 1 ELSE A.CANTEMPAQ END)) FROM SAINITI I WHERE I.CODPROD=A.CODPROD  AND I.PERIODO=A.PERIODO)*(SELECT TOP 1 I.COSTOFINAL FROM SAINITI I WHERE I.CODPROD=A.CODPROD  AND I.PERIODO=A.PERIODO) AS MTOCOSTEXFINALPERFROM(SELECT    SI.CODITEM AS CODPROD,    SI.TIPOFAC AS TIPO,    P.CANTEMPAQ,    P.COSTPRO,    I.CODINST,    I.DESCRIP AS INSTDESCRIP,    YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,    SUM(S.SIGNO*SI.CANTIDAD*SI.CANTMAYOR/CASE WHEN SI.ESUNID=1 THEN (CASE WHEN P.CANTEMPAQ=0 THEN 1 ELSE P.CANTEMPAQ END) ELSE 1 END) AS CANTIDAD,    SUM(S.SIGNO*SI.CANTIDAD*SI.CANTMAYOR*SI.COSTO) AS COSTO,    SUM(CASE S.MONTO WHEN 0 THEN S.SIGNO*SI.CANTIDAD*SI.PRECIO         ELSE S.SIGNO*SI.CANTIDAD*(SI.PRECIO -(S.DESCTO1+S.DESCTO2)*SI.PRECIO/S.MONTO)     END) AS TOTPRECIO,    SUM(CASE S.MONTO WHEN 0 THEN S.SIGNO*SI.CANTIDAD*(SI.PRECIO -SI.COSTO)         ELSE S.SIGNO*SI.CANTIDAD*((SI.PRECIO -(S.DESCTO1+S.DESCTO2)*SI.PRECIO/S.MONTO)-SI.COSTO)     END) AS UTILIDAD   FROM SAFACT AS S JOIN        SAITEMFAC AS SI ON (s.codSucu=si.codsucu) And (S.TIPOFAC=SI.TIPOFAC) AND  (S.NUMEROD=SI.NUMEROD)        JOIN SAPROD AS P ON (SI.CODITEM=P.CODPROD)        JOIN  SAINSTA AS I ON (P.CODINST=I.CODINST)  WHERE (SI.DESCOMP= 0)  AND (SI.TIPOFAC IN ('A','B','C','D'))  GROUP BY  SI.CODITEM,SI.TIPOFAC,YEAR(S.FECHAE)*100+MONTH(S.FECHAE),P.CANTEMPAQ,P.COSTPRO,I.CODINST,I.DESCRIPUNION ALLSELECT  SI.CODITEM,  SI.TIPOCOM AS TIPO,  P.CANTEMPAQ,  P.COSTPRO,  I.CODINST,  I.DESCRIP AS INSTDESCRIP,  YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,  SUM(S.SIGNO*SI.CANTIDAD/CASE WHEN SI.ESUNID=1 THEN (CASE WHEN P.CANTEMPAQ=0 THEN 1 ELSE P.CANTEMPAQ END) ELSE 1 END) AS CANTIDAD,  SUM(S.SIGNO*SI.CANTIDAD*SI.COSTO) AS COSTO,  0.0 AS TOTPRECIO,  0.0 AS UTILIDAD  FROM SACOMP AS S JOIN        SAITEMCOM AS SI ON (s.codSucu=si.codsucu) And (S.TIPOCOM=SI.TIPOCOM) AND  (S.NUMEROD=SI.NUMEROD) AND  (S.NUMEROD=SI.NUMEROD) AND  (S.CODPROV=SI.CODPROV)        JOIN SAPROD AS P ON (SI.CODITEM=P.CODPROD)        JOIN  SAINSTA AS I ON (P.CODINST=I.CODINST)  WHERE  (SI.TIPOCOM IN ('H','I','J','K'))  GROUP BY  SI.CODITEM, SI.TIPOCOM,YEAR(S.FECHAE)*100+MONTH(S.FECHAE),P.CANTEMPAQ,P.COSTPRO,I.CODINST,I.DESCRIPUNION ALLSELECT    SI.CODITEM,    SI.TIPOOPI AS TIPO,    P.CANTEMPAQ,    P.COSTPRO,    I.CODINST,    I.DESCRIP AS INSTDESCRIP,    YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,    SUM(S.SIGNO*(CASE WHEN SI.TIPOOPI = 'Q' THEN (SI.CANTIDAD-SI.CANTIDADA)             ELSE CASE WHEN SI.TIPOOPI IN ('N','P') THEN -SI.CANTIDAD ELSE S.SIGNO*SI.CANTIDAD END           END)         /CASE WHEN SI.ESUNID=1 THEN (CASE WHEN P.CANTEMPAQ=0 THEN 1 ELSE P.CANTEMPAQ END) ELSE 1 END) AS CANTIDAD,    SUM(S.SIGNO*(CASE WHEN SI.TIPOOPI = 'Q' THEN (SI.CANTIDAD-SI.CANTIDADA)             ELSE CASE WHEN SI.TIPOOPI IN ('N','P') THEN -SI.CANTIDAD ELSE S.SIGNO*SI.CANTIDAD END           END)         *SI.COSTO) AS COSTO,  0.0 AS TOTPRECIO,  0.0 AS UTILIDAD    FROM SAOPEI AS S JOIN       SAITEMOPI AS SI ON (s.codSucu=si.codsucu) And (S.TIPOOPI=SI.TIPOOPI) AND  (S.NUMEROD=SI.NUMEROD)       JOIN SAPROD AS P ON (SI.CODITEM=P.CODPROD)       JOIN  SAINSTA AS I ON (P.CODINST=I.CODINST)    WHERE ((SI.TIPOOPI IN ('N','O','P')) OR (ABS(SI.CANTIDAD-SI.CANTIDADA)>0 AND SI.TIPOOPI='Q'))    GROUP BY  SI.CODITEM, SI.TIPOOPI, YEAR(S.FECHAE)*100+MONTH(S.FECHAE),P.CANTEMPAQ,P.COSTPRO,I.CODINST,I.DESCRIPUNION ALLSELECT  SI.CODITEM,  SI.TIPOOPI AS TIPO,  P.CANTEMPAQ,  P.COSTPRO,  I.CODINST,  I.DESCRIP AS INSTDESCRIP,  YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,  SUM(S.SIGNO*SI.CANTIDAD/CASE WHEN SI.ESUNID=1 THEN (CASE WHEN P.CANTEMPAQ=0 THEN 1 ELSE P.CANTEMPAQ END) ELSE 1 END) AS CANTIDAD,  SUM(S.SIGNO*SI.CANTIDAD*SI.COSTO) AS COSTO,  0.0 AS TOTPRECIO,  0.0 AS UTILIDADFROM SAOPEI AS S JOIN     SAITEMOPI AS SI ON (s.codSucu=si.codsucu) And (S.TIPOOPI=SI.TIPOOPI) AND  (S.NUMEROD=SI.NUMEROD)     JOIN SAPROD AS P ON (SI.CODITEM=P.CODPROD)     JOIN  SAINSTA AS I ON (P.CODINST=I.CODINST)WHERE (SI.TIPOOPI='N')GROUP BY  SI.CODITEM, SI.TIPOOPI,YEAR(S.FECHAE)*100+MONTH(S.FECHAE),P.CANTEMPAQ,P.COSTPRO,I.CODINST,I.DESCRIPUNION ALLSELECT    SI.CODITEM,    SI.TIPOOPI AS TIPO,    P.CANTEMPAQ,    P.COSTPRO,    I.CODINST,    I.DESCRIP AS INSTDESCRIP,    YEAR(S.FECHAE)*100+MONTH(S.FECHAE) AS PERIODO,    SUM(S.SIGNO*(SI.CANTIDADU-SI.CANTIDADUA)/CASE WHEN SI.ESUNID=0 THEN (CASE WHEN P.CANTEMPAQ=0 THEN 1 ELSE P.CANTEMPAQ END) ELSE 1 END) AS CANTIDAD,    SUM(S.SIGNO*(SI.CANTIDADU-SI.CANTIDADUA)*SI.COSTO) AS COSTO,    0.0 AS TOTPRECIO,    0.0 AS UTILIDAD    FROM SAOPEI AS S JOIN       SAITEMOPI AS SI ON (s.codSucu=si.codsucu) And (S.TIPOOPI=SI.TIPOOPI) AND  (S.NUMEROD=SI.NUMEROD)       JOIN SAPROD AS P ON (SI.CODITEM=P.CODPROD)       JOIN  SAINSTA AS I ON (P.CODINST=I.CODINST)    WHERE (ABS(SI.CANTIDADU-SI.CANTIDADUA)>0 AND SI.TIPOOPI='Q')    GROUP BY  SI.CODITEM, SI.TIPOOPI,YEAR(S.FECHAE)*100+MONTH(S.FECHAE),P.CANTEMPAQ,P.COSTPRO,I.CODINST,I.DESCRIPUNION ALLSELECT    P.CODPROD,    'A' AS TIPO,    P.CANTEMPAQ,   P.COSTPRO,    I.CODINST,    I.DESCRIP AS INSTDESCRIP,    YEAR(GETDATE())*100+MONTH(GETDATE()) AS PERIODO,    0.0 AS CANTIDAD,    0.0 AS COSTO,    0.0 AS TOTPRECIO,    0.0 AS UTILIDAD    FROM SAPROD AS P JOIN  SAINSTA AS I ON (P.CODINST=I.CODINST)) A GROUP BY PERIODO,CODPROD,CODINST,INSTDESCRIP,CANTEMPAQ,COSTPRO
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_FLDSADDVTA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_FLDSADDVTA;
GO
Create View dbo.VW_ADM_FLDSADDVTA  AS SELECT A.Name as TblName, C.CodTbl, C.TipoCpo, O.NROOPER, C.NumGrp,        G.ALIASGRP, C.NOMBCPO, C.AliasCPO, C.Longitud, C.Requerido, B.ColOrder FROM SAAGRUPOS G WITH (NOLOCK)   INNER JOIN SAACAMPOS C ON      C.CODTBL=G.CODTBL AND G.NUMGRP=C.NUMGRP  INNER JOIN SYSOBJECTS A ON      A.NAME LIKE G.CODTBL+'%' AND LEN(G.CODTBL)<>LEN(A.NAME) AND A.XTYPE='U'   INNER JOIN SYSCOLUMNS B ON      A.ID=B.ID AND B.NAME=C.NOMBCPO  LEFT  JOIN SAAOPER O ON      O.CODTBL=C.CODTBL AND O.NUMGRP=C.NUMGRP WHERE (C.CODTBL LIKE 'SAITEPRDFAC%' OR        C.CODTBL LIKE 'SAITESERVFAC%' OR        C.CODTBL LIKE 'SAFACT%' )
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_FLDSADDCOMP' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_FLDSADDCOMP;
GO
Create View dbo.VW_ADM_FLDSADDCOMP  AS SELECT A.Name as TblName, C.CodTbl, C.TipoCpo, O.NROOPER, C.NumGrp,        G.ALIASGRP, C.NOMBCPO, C.AliasCPO, C.Longitud, C.Requerido, B.ColOrder FROM SAAGRUPOS G WITH (NOLOCK)   INNER JOIN SAACAMPOS C ON      C.CODTBL=G.CODTBL AND G.NUMGRP=C.NUMGRP  INNER JOIN SYSOBJECTS A ON      A.NAME LIKE G.CODTBL+'%' AND LEN(G.CODTBL)<>LEN(A.NAME) AND A.XTYPE='U'   INNER JOIN SYSCOLUMNS B ON      A.ID=B.ID AND B.NAME=C.NOMBCPO  LEFT  JOIN SAAOPER O ON      O.CODTBL=C.CODTBL AND O.NUMGRP=C.NUMGRP WHERE (C.CODTBL LIKE 'SAITEPRDCOM%' OR        C.CODTBL LIKE 'SAITESERVCOM%' OR        C.CODTBL LIKE 'SACOMP%' )
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_FLDSADDOPI' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_FLDSADDOPI;
GO
Create View dbo.VW_ADM_FLDSADDOPI  AS SELECT A.Name as TblName, C.CodTbl, C.TipoCpo, O.NROOPER, C.NumGrp,        G.ALIASGRP, C.NOMBCPO, C.AliasCPO, C.Longitud, C.Requerido, B.ColOrder FROM SAAGRUPOS G WITH (NOLOCK)   INNER JOIN SAACAMPOS C ON      C.CODTBL=G.CODTBL AND G.NUMGRP=C.NUMGRP  INNER JOIN SYSOBJECTS A ON      A.NAME LIKE G.CODTBL+'%' AND LEN(G.CODTBL)<>LEN(A.NAME) AND A.XTYPE='U'   INNER JOIN SYSCOLUMNS B ON      A.ID=B.ID AND B.NAME=C.NOMBCPO  LEFT  JOIN SAAOPER O ON      O.CODTBL=C.CODTBL AND O.NUMGRP=C.NUMGRP WHERE (C.CODTBL LIKE 'SAITEPRDOPI%' OR        C.CODTBL LIKE 'SAITESERVOPI%' OR        C.CODTBL LIKE 'SAOPEI%' )
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_MOVPROD' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_MOVPROD;
GO
create view dbo.VW_ADM_MOVPROD  AS Select  P.CodProd,      P.DESCRIP,      P.CODINST,      P.ESENSER,      P.ESIMPORT,      P.ESEMPAQUE,      P.EXISTEN,     P.EXUNIDAD,      P.MARCA,      SI.TipoFac As Tipo,      SI.NumeroD,      SI.FechaE,      S.CodClie As Codigo,      SI.CodUbic As CodUbic1,      NULL As CodUbic2,      S.Descrip AS DESCRIPT,      SI.EsUnid,      SI.NroLinea,      SUM(SI.Costo) As Costo,      SUM(SI.Precio) As Precio,  SUM(SI.Cantidad*SI.CantMayor) As Cantidad,  SUM(Case si.esunid when 1 Then SI.existAntU          Else SI.existAnt End) As ExistAnt, SUM((Case When SI.TipoFac In ('B','D') Then 1           Else 0 End)*          SI.Cantidad*SI.CantMayor) As Entrada,     SUM((Case When SI.TipoFac In ('A','C') Then 1           Else 0 End)*          SI.Cantidad*SI.CantMayor) As Salida, SUM((Case si.esunid when 1 Then SI.existAntU           Else SI.existAnt End)-         (Case When SI.TipoFac In ('B','D') Then -1           Else 1 End)*SI.Cantidad*SI.CantMayor) As Saldo From SAPROD As P,       SAINSTA AS I,       SAFACT As S,       SAITEMFAC As SI WITH (NOLOCK)  Where (P.CodProd=SI.CodItem) AND (P.CODINST=I.CODINST)   And (P.DEsComp= 0) And (S.TipoFac=SI.TipoFac)   And (S.NumeroD=SI.NumeroD) And (S.codSucu=SI.codsucu)   And (SI.TipoFac In ('A' ,'B','C','D')) Group By  P.CodProd, si.FechaE, SI.Existant, SI.CodUbic, S.Descrip,            SI.EsUnid, SI.NroLinea, SI.TipoFac, SI.ExistantU, S.CodClie,            SI.NumeroD, P.DESCRIP, P.CODINST, P.ESENSER, P.ESIMPORT,            P.ESEMPAQUE, P.MARCA, P.EXISTEN, P.EXUNIDAD Union ALL (Select P.CodProd,      P.DESCRIP,      P.CODINST,      P.ESENSER,      P.ESIMPORT,      P.ESEMPAQUE,      P.EXISTEN,     P.EXUNIDAD,      P.MARCA,      SI.TipoCOM As Tipo,      SI.NumeroD,      SI.FechaE,      S.CodPROV As Codigo,      SI.CodUbic As CodUbic1,      NULL AS CODUBIC2,      S.DESCRIP AS DESCRIPT,      SI.EsUnid,      SI.NroLinea,      SUM(SI.Costo) As Costo,      SUM(SI.Costo) As Precio,      SUM(SI.Cantidad) As Cantidad,      SUM(case si.esunid when 1 Then SI.existAntU         else SI.existAnt End) As ExistAnt,     SUM((Case When si.TipoCom In ('H','J') Then 1          Else 0 End)*SI.Cantidad) As Entrada,     SUM((Case When si.TipoCom In ('I','K') Then 1           Else 0 End)*SI.Cantidad) As Salida,      SUM((case si.esunid  when 1 Then SI.existAntU          else SI.existAnt End)+(Case When si.TipoCom In ('H','J') Then 1                                Else -1 End)*SI.Cantidad) As Saldo From SAPROD As P,       SAINSTA AS I,       SACOMP As S,       SAITEMCOM As SI  WITH (NOLOCK)  Where (P.CodProd=SI.CodItem) AND (P.CODINST=I.CODINST)  And (S.codSucu=SI.codsucu) And (S.TipoCom=SI.TipoCom)   And (S.NumeroD=SI.NumeroD)   And (S.CodProv=SI.CodProv)   And (SI.TipoCom In ('H','I','J','K')) Group by  P.CodProd, si.FechaE, si.existAnt, si.CodUbic, S.Descrip, SI.EsUnid, SI.NroLinea,            si.TipoCom, SI.ExistantU, S.CodProv, Si.NumeroD,            P.DESCRIP, P.CODINST, P.ESENSER, P.ESIMPORT,            P.ESEMPAQUE, P.MARCA, P.EXISTEN,P.EXUNIDAD)Union ALL ( Select  P.CodProd,      P.DESCRIP,      P.CODINST,      P.ESENSER,      P.ESIMPORT,      P.ESEMPAQUE,      P.EXISTEN,     P.EXUNIDAD,      P.MARCA,      SI.TipoOPI As Tipo,      SI.NumeroD,      SI.FechaE,      NULL As Codigo,      SI.CodUbic,      NULL AS Codubic2,      S.USOMAT AS DESCRIPT,      SI.EsUnid,      SI.NroLinea,      SUM(si.Costo) as Costo,      SUM(si.Costo) as Precio,  SUM(Case When si.TipoOpI In ('O','N','P') Then SI.Cantidad              Else Abs(SI.CantidadA-SI.Cantidad)          End) AS Cantidad,      SUM(Case si.esunid when 1 Then SI.existAntU          Else SI.existAnt End) As ExistAnt, SUM((Case When si.TipoOpI='O' Then SI.Cantidad       When si.TipoOpI In ('N','P') Then 0       When si.TipoOpI='Q' Then               (Case When SI.CantidadA-SI.Cantidad<0 then                     Abs(SI.CantidadA-SI.Cantidad)                Else 0 End)            End)) as Entrada,     SUM((Case When si.TipoOpI='O' Then 0        When si.TipoOpI In ('N','P') Then SI.Cantidad       When si.TipoOpI='Q' Then               (Case When SI.CantidadA-SI.Cantidad<0 then 0                Else Abs(SI.CantidadA-SI.Cantidad) End)          End)) as Salida,      SUM((Case si.esunid when 1 Then SI.existAntU           else SI.existAnt End)+(Case When SI.TipoOpI='O' Then SI.Cantidad                        When SI.TipoOpI In ('N','P') Then -SI.Cantidad                        When SI.TipoOpI='Q' Then                              (Case When SI.CantidadA-SI.Cantidad<=0 Then                                        Abs(SI.CantidadA-SI.Cantidad)                               Else -Abs(SI.CantidadA-SI.Cantidad) End)                       End)) As Saldo  From SAPROD as P,       SAINSTA AS I,       SAOPEI As S,       SAITEMOPI As SI WITH (NOLOCK)   Where (P.CodProd = SI.CodItem) AND (P.CODINST=I.CODINST) And (S.CodSucu=SI.CodSucu)  And (S.TipoOpI=SI.TipoOpI)  And (S.NumeroD=SI.NumeroD)   And (SI.TipoOpI In ('N','O','Q','P')) Group by  P.CodProd, si.FechaE, si.existAnt, si.CodUbic, si.CodUbic2, S.UsoMat,            SI.EsUnid, SI.ExistantU, SI.NroLinea, si.TipoOpI,  S.Autori, Si.NumeroD,            P.DESCRIP, P.CODINST, P.ESENSER, P.ESIMPORT,            P.ESEMPAQUE, P.MARCA, P.EXISTEN, P.EXUNIDAD)Union ALL ( SELECT  P.CodProd,      P.DESCRIP,      P.CODINST,      P.ESENSER,      P.ESIMPORT,      P.ESEMPAQUE,      P.EXISTEN,      P.EXUNIDAD,      P.MARCA,      SI.TipoOPI As Tipo,      SI.NumeroD,      SI.FechaE+0.001,      NULL As Codigo,      SI.CodUbic2,      SI.CodUbic,      S.USOMAT AS DESCRIPT,      SI.EsUnid,      SI.NroLinea,      SUM(SI.Costo) as Costo,      SUM(SI.Costo) as Precio,      SUM(SI.Cantidad) as Cantidad,      SUM(case si.esunid when 1 Then SI.existAntU         else SI.existAnt End) As ExistAnt,     SUM(SI.Cantidad) as Entrada,     SUM(0) as Salida,      SUM((case si.esunid when 1 Then SI.existAntU           else SI.existAnt End)) As Saldo From SAPROD as P,       SAINSTA AS I,       SAOPEI As S,       SAITEMOPI As SI WITH (NOLOCK)  Where (P.CodProd=SI.CodItem) AND (P.CODINST=I.CODINST) And (P.DEsComp= 0)  And (S.CODSUCU=SI.CODSUCU)  And (S.TipoOpI=SI.TipoOpI)  And (S.NumeroD=SI.NumeroD)  And (SI.TipoOpI='N') Group by  P.CodProd, si.FechaE, si.existAnt, SI.ExistantU,   si.CodUbic, si.CodUbic2, S.UsoMat, SI.EsUnid, SI.NroLinea, si.TipoOpI,   s.Autori, Si.NumeroD, P.DESCRIP, P.CODINST, P.ESENSER, P.ESIMPORT,   P.ESEMPAQUE, P.MARCA, P.EXISTEN,P.EXUNIDAD)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_CIERRES' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_CIERRES;
GO
create view VW_ADM_CIERRES  AS SELECT '0' AS TIPO, CONVERT(datetime, CONVERT(char(8), FechaE, 112)) AS FECHAE, CodEsta,        ISNULL(SUM(Signo*(CancelE + CancelC + CancelT + CancelA + CancelI)), 0.00) AS TOTCONTADO,       ISNULL(SUM(Signo*(Monto-(Descto1+Descto2)+Fletes+(MtoTax-RetenIVA)-(CancelE+CancelC+CancelT+CancelA+CancelI))), 0.00) AS TOTCREDITO,        ISNULL(SUM(Signo*(Monto-(Descto1+Descto2)+Fletes)), 0.00) AS TOTAL,       ISNULL(SUM(TGravable * Signo), 0.00) AS TOTGRAVABLE,        ISNULL(SUM(MtoTax * Signo), 0.00) AS TOTIMPUESTO,       ISNULL(SUM(RetenIVA * Signo), 0.00) AS TOTRETENIVA,       ISNULL(SUM(CancelE * Signo), 0.00) AS TOTEFECTIVO,       ISNULL(SUM(CancelG * Signo), 0.00) AS TOTOTROS,       ISNULL(SUM(CancelC * Signo), 0.00) AS TOTCHEQUE,        ISNULL(SUM(CancelT * Signo), 0.00) AS TOTTARJETA,       ISNULL(SUM(CancelA * Signo), 0.00) AS TOTADELANTOS,       ISNULL(SUM(TotalPrd * Signo), 0.00) AS TOTPRODUCTOS,       ISNULL(SUM(TotalSrv * Signo), 0.00) AS TOTSERVICIOS,       ISNULL(SUM(TExento * Signo), 0.00) AS TOTVENTAEXENTA,        ISNULL(SUM(Fletes * Signo), 0.00) AS TOTFLETES,       ISNULL(SUM((Descto1 + Descto2) * Signo), 0.00) AS TOTDESCUENTOS,       CAST(0.0 AS decimal(18, 2)) AS TOTEXCLUIDO,       ISNULL(SUM(CASE WHEN TIPOFAC = 'A' THEN 1 ELSE 0 END), 0) AS CONTFACTURAS,        ISNULL(SUM(CASE WHEN TIPOFAC = 'B' THEN 1 ELSE 0 END), 0) AS CONTDEVOLUCIONES,      (SELECT MIN(NumeroD) AS Expr1         FROM dbo.SAFACT AS F        WHERE (TipoFac = 'A') AND              (CONVERT(datetime, CONVERT(char(8), FechaE, 112)) =              CONVERT(datetime, CONVERT(char(8), SF.FechaE, 112))))         AS NUMFACI,        (SELECT MAX(NumeroD) AS Expr1        FROM    dbo.SAFACT AS F        WHERE   (TipoFac='A') AND (CONVERT(datetime, CONVERT(char(8), FechaE, 112)) =                 CONVERT(datetime, CONVERT(char(8), SF.FechaE, 112))))         AS NUMFACFFROM  dbo.SAFACT AS SFWHERE (TipoFac IN ('A', 'B'))GROUP BY CONVERT(datetime, CONVERT(char(8), FechaE, 112)), CodEsta
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_CIERRES_TAXES' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_CIERRES_TAXES;
GO
create view VW_ADM_CIERRES_TAXES  AS SELECT CONVERT(datetime, CONVERT(char(8), F.FechaE, 112)) AS FECHAE,F.CodEsta, T.CodTaxs,       ISNULL(SUM(T.Monto * F.Signo), 0.00) AS TOTMTOTAX,        ISNULL(SUM(T.TGravable * F.Signo), 0.00) AS TOTGRAVABLETAX  FROM dbo.SATAXVTA AS T INNER JOIN       dbo.SAFACT AS F ON          (t.codSucu=f.codsucu) And T.NumeroD = F.NumeroD AND T.TipoFac = F.TipoFacGROUP BY CONVERT(datetime, CONVERT(char(8), F.FechaE, 112)), F.CodEsta,T.CodTaxs
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_SAPROV' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_SAPROV;
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_SAVEND' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_SAVEND;
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_SACLIE' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_SACLIE;
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_SAMECA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_SAMECA;
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_PRODxINSTA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_PRODxINSTA;
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_SERVxINSTA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_SERVxINSTA;
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_CIERRES_INSTA' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_CIERRES_INSTA;
GO
CREATE VIEW VW_ADM_CIERRES_INSTA AS SELECT DATEADD(dd, DATEDIFF(dd, 0, F.FechaE), 0) as FechaE,         F.CodEsta as 'Estacion',It.CodInst as 'Codigo Instancia',         IT.Descrip as 'Descripcion Instancia', TV.CodTaxs as 'Codigo Impuesto',        TX.Descrip as 'Descripcion Impuesto', Sum(TV.Monto) As 'Total Monto Impuesto',        SUM(TV.TGravable) as 'Total Gravable Impuesto'    FROM SAITEMFAC I    JOIN SAFACT F ON         (i.codSucu=f.codsucu) And (I.NumeroD=F.NumeroD) AND (I.TipoFac=F.TipoFac)    JOIN SAPROD P ON         (I.CodItem=P.CodProd)    JOIN SAINSTA IT ON         (P.CodInst=IT.CodInst)    JOIN SATAXITF TV ON         (tv.codSucu=i.codsucu) And (TV.NumeroD=I.NumeroD) aND (TV.TipoFac=I.TipoFac) And         (TV.NroLinea=I.NroLinea) And (TV.NroLineaC=I.NroLineaC)   JOIN SATAXES TX ON (TV.CodTaxs=TX.CodTaxs)  GROUP BY DATEADD(dd, DATEDIFF(dd, 0, F.FechaE), 0), F.CodEsta,           It.CodInst, IT.Descrip, TV.CodTaxs, TX.Descrip
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_LIBROIVAVENTAS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_LIBROIVAVENTAS;
GO
CREATE VIEW DBO.VW_ADM_LIBROIVAVENTAS AS SELECT (CASE WHEN F.TIPOFAC='A' THEN '01-REG' ELSE '03-REG' END) As TipoReg,   F.CodSucu,   F.TipoFac As Tipo,   F.FechaE As FechaEmision,   F.FechaI As FechaFactura,   F.fechaT,   F.ID3 As RifCliente,   F.NumeroP as NroImprFiscal,   F.NumeroF As NroFacturaFiscal,  F.Descrip As Nombre,   F.CodClie As CodCliente,  C.tipocli As TipoCliente,  (Case C.tipocli      when 0 then 'Contribuyente'     when 1 then 'Consumidor final'     when 2 then 'Exportacion'     when 3 then 'Interno'      when 4 then 'Contribuyente especial'   End) As DescrTipoClie,  F.CodOper,  (Case When F.TipoFac='A' Then 'FAC' Else    (CASE IsNull((SELECT CORRELUNC FROM SACONF),0) WHEN 1 THEN 'N/C' ELSE 'DEV' END) END) AS TIPODOC,     F.NumeroD As NumeroDOC,     F.NumeroR AS FactAfectada,     F.NroCtrol,      F.Signo*(F.Monto+F.Fletes-(F.Descto1+F.Descto2)) AS TOTALVENTAS,     F.Signo*(F.Monto+F.Fletes+F.MtoTax-(F.Descto1+F.Descto2)) AS TOTALVENTASCONIVA,      F.Signo*(F.TExento+F.Fletes*(SELECT (case when IMPFLETEV=0 then 1 else 0 end)                                     FROM SACONF WHERE CODSUCU='00000')) AS MtoExento,  (Case when C.tipocli<>1 then          f.Signo*(F.TGravable-F.TGravable*(F.DESCTO1+F.DESCTO2)/(case when F.Monto=0 then 1 else F.monto end))        else 0 end) As TotalGravable_Contribuye,   (Case when C.tipocli<>1 then f.Signo*f.MtoTax        else 0 end) As TotalIVAContribuye,   (Case when C.tipocli=1 Then           f.Signo*(F.TGravable-F.TGravable*(F.DESCTO1+F.DESCTO2)/(case when F.Monto=0 then 1 else F.monto end))        else 0 end) As TotalGravable_NoContribuye,   (Case when C.tipocli=1 Then f.Signo*f.MtoTax        else 0 end) As TotalIVANoContribuye,    (Case when C.tipocli<>1 then         F.Signo*isnull((Select top 1 t.tgravable                         From sataxvta T  WITH (NOLOCK)                         Where t.codtaxs='IAL' And                               t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MtoGravable_ContribuyeIAL,    (Case when C.tipocli<>1 then          F.Signo*IsNull((Select top 1 t.Monto                           From sataxvta t  WITH (NOLOCK)                          Where t.codtaxs='IAL' and                                t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MontoIVA_ContribuyeIAL,   (Case when C.tipocli<>1 then         IsNull((Select top 1 t.MtoTax                   From sataxvta t WITH (NOLOCK)                  Where t.codtaxs='IAL' And                        (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_ContribuyeIAL,   (Case when C.tipocli=1 then          F.Signo*isnull((Select top 1 t.tgravable                           From sataxvta T WITH (NOLOCK)                           Where t.codtaxs='IAL' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MtoGravable_NoContribuyeIAL,    (Case when C.tipocli=1 then          F.Signo*IsNull((Select top 1 t.Monto                            From sataxvta t WITH (NOLOCK)                           Where t.codtaxs='IAL' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MontoIVA_NoContribuyeIAL,   (Case when C.tipocli=1 then          IsNull((Select top 1 t.MtoTax                    From sataxvta t WITH (NOLOCK)                   Where t.codtaxs='IAL' and                         (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_NoContribuyeIAL,   (Case when C.tipocli<>1 then         F.Signo*isnull((Select top 1 t.tgravable                         From sataxvta T  WITH (NOLOCK)                         Where t.codtaxs='IVA' And                               t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MtoGravable_ContribuyeIVA,    (Case when C.tipocli<>1 then          F.Signo*IsNull((Select top 1 t.Monto                           From sataxvta t  WITH (NOLOCK)                          Where t.codtaxs='IVA' and                                t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MontoIVA_ContribuyeIVA,   (Case when C.tipocli<>1 then         IsNull((Select top 1 t.MtoTax                   From sataxvta t WITH (NOLOCK)                  Where t.codtaxs='IVA' And                        (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_ContribuyeIVA,   (Case when C.tipocli=1 then          F.Signo*isnull((Select top 1 t.tgravable                           From sataxvta T WITH (NOLOCK)                           Where t.codtaxs='IVA' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MtoGravable_NoContribuyeIVA,    (Case when C.tipocli=1 then          F.Signo*IsNull((Select top 1 t.Monto                            From sataxvta t WITH (NOLOCK)                           Where t.codtaxs='IVA' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MontoIVA_NoContribuyeIVA,   (Case when C.tipocli=1 then          IsNull((Select top 1 t.MtoTax                    From sataxvta t WITH (NOLOCK)                   Where t.codtaxs='IVA' and                         (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_NoContribuyeIVA,   (Case when C.tipocli<>1 then         F.Signo*isnull((Select top 1 t.tgravable                         From sataxvta T  WITH (NOLOCK)                         Where t.codtaxs='IVAAD' And                               t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MtoGravable_ContribuyeIVAAD,    (Case when C.tipocli<>1 then          F.Signo*IsNull((Select top 1 t.Monto                           From sataxvta t  WITH (NOLOCK)                          Where t.codtaxs='IVAAD' and                                t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MontoIVA_ContribuyeIVAAD,   (Case when C.tipocli<>1 then         IsNull((Select top 1 t.MtoTax                   From sataxvta t WITH (NOLOCK)                  Where t.codtaxs='IVAAD' And                        (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_ContribuyeIVAAD,   (Case when C.tipocli=1 then          F.Signo*isnull((Select top 1 t.tgravable                           From sataxvta T WITH (NOLOCK)                           Where t.codtaxs='IVAAD' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MtoGravable_NoContribuyeIVAAD,    (Case when C.tipocli=1 then          F.Signo*IsNull((Select top 1 t.Monto                            From sataxvta t WITH (NOLOCK)                           Where t.codtaxs='IVAAD' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MontoIVA_NoContribuyeIVAAD,   (Case when C.tipocli=1 then          IsNull((Select top 1 t.MtoTax                    From sataxvta t WITH (NOLOCK)                   Where t.codtaxs='IVAAD' and                         (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_NoContribuyeIVAAD,   (Case when C.tipocli<>1 then         F.Signo*isnull((Select top 1 t.tgravable                         From sataxvta T  WITH (NOLOCK)                         Where t.codtaxs='IVAT1' And                               t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MtoGravable_ContribuyeIVAT1,    (Case when C.tipocli<>1 then          F.Signo*IsNull((Select top 1 t.Monto                           From sataxvta t  WITH (NOLOCK)                          Where t.codtaxs='IVAT1' and                                t.tipofac=f.tipofac and (t.codSucu=f.codsucu) And t.numerod=f.numerod),0)    else 0 end) As MontoIVA_ContribuyeIVAT1,   (Case when C.tipocli<>1 then         IsNull((Select top 1 t.MtoTax                   From sataxvta t WITH (NOLOCK)                  Where t.codtaxs='IVAT1' And                        (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_ContribuyeIVAT1,   (Case when C.tipocli=1 then          F.Signo*isnull((Select top 1 t.tgravable                           From sataxvta T WITH (NOLOCK)                           Where t.codtaxs='IVAT1' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MtoGravable_NoContribuyeIVAT1,    (Case when C.tipocli=1 then          F.Signo*IsNull((Select top 1 t.Monto                            From sataxvta t WITH (NOLOCK)                           Where t.codtaxs='IVAT1' and                                 (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As MontoIVA_NoContribuyeIVAT1,   (Case when C.tipocli=1 then          IsNull((Select top 1 t.MtoTax                    From sataxvta t WITH (NOLOCK)                   Where t.codtaxs='IVAT1' and                         (t.codSucu=f.codsucu) And t.tipofac=f.tipofac and t.numerod=f.numerod),0)    else 0 end) As Alicuota_NoContribuyeIVAT1,    F.Signo*F.RetenIVA AS RetencionIVA,     (case when F.RetenIVA<>0 Then           F.Signo*(F.MtoTax-F.RetenIVA)      Else 0 End) As DifRetencion,     (case when F.RetenIVA<>0 Then           F.Signo*Round(F.RetenIVA/F.MtoTax*100,2)      Else 0 End) As PorctReten,     f.NumeroT As NroRetencion,     f.FechaR  As FechaRetencion,     F.NroUnico As NroUnico,     0 AS DBZFROM SAFACT F WITH (NOLOCK)  LEFT JOIN SACLIE C ON   F.CodClie = C.CodClieWHERE (F.TipoFac IN ('A','B')) UNION ALL (SELECT (CASE WHEN F.TipoCxc='10' Then '01-REG'                WHEN F.TipoCxc='20' THEN '02-REG'                WHEN SUBSTRING(F.TipoCxc,1,1) in ('3','8') THEN '03-REG' END) As TipoReg,    F.CodSucu,    F.TipoCxc,    F.FechaE,    F.FechaI,    F.FechaT,    C.ID3,    NULL as NroImprFiscal,    NULL As NroFacturaFiscal,   C.Descrip As Nombre,    C.codclie As CodCliente,   C.tipocli As TipoCliente,   (Case C.tipocli      when 0 then 'Contribuyente'     when 1 then 'Consumidor final'     when 2 then 'Exportacion'     when 3 then 'Interno'      when 4 then 'Contribuyente especial'    End) As DescrTipoClie,   F.CodOper,   (CASE WHEN F.TipoCxc = '10' THEN 'FAC'          WHEN F.TipoCxc = '20' THEN 'N/D'          WHEN F.TipoCxc = '31' THEN 'N/C'          WHEN F.TipoCxc = '81' THEN 'RET'     ELSE null END) AS TIPODOC,   F.NumeroD As NumeroDoc,    f.numeroN As factAfectada,   F.NroCtrol,    F.Monto*   (CASE WHEN F.TipoCxc in ('10','20') THEN  1          WHEN F.TipoCxc in ('31') THEN -1          WHEN F.TipoCxc in ('81') THEN 0 END) AS TotalVentas,   F.MontoNeto*(CASE WHEN F.TipoCxc in ('10','20') THEN 1                    WHEN F.TipoCxc in ('31') THEN -1                  WHEN F.TipoCxc in ('81') THEN 0 END) As TotalVentasConIVA,   F.TExento*(CASE WHEN f.TipoCxc in ('10','20') THEN 1                   WHEN f.TipoCxc in ('31') THEN -1                   WHEN F.TipoCxc in ('81') THEN 0 END) As MtoExento,   (Case when C.tipocli<>1 then         (CASE WHEN f.TipoCxc in ('10','20') THEN 1               WHEN f.TipoCxc in ('31') THEN -1               WHEN f.TipoCxc in ('81') THEN 1 END)*f.BaseImpo    else 0 end),    (Case when C.tipocli<>1 then          (CASE WHEN f.TipoCxc in ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 1 END)*f.MtoTax    else 0 end),    (Case when C.tipocli=1 then         (CASE WHEN f.TipoCxc in ('10','20') THEN 1               WHEN f.TipoCxc in ('31') THEN -1               WHEN f.TipoCxc in ('81') THEN 1 END)*f.BaseImpo    else 0 end),    (Case when C.tipocli=1 then          (CASE WHEN f.TipoCxc in ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 1 END)*f.MtoTax    else 0 end),    (Case when C.tipocli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31')  THEN -1                WHEN f.TipoCxc in ('81')  THEN 0 END)*         Isnull((SELECT top 1 T.TGravable FROM SATAXCXC T WITH (NOLOCK)                  WHERE T.Codtaxs='IAL' And                       T.NroPpal=f.NroUnico),0)     else 0 end),    (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IAL' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 T.MtoTax FROM SATAXCXC T WITH (NOLOCK)                  WHERE t.codtaxs='IAL' And                      t.nroppal=f.nrounico),0)     else 0 end),   (Case when C.TipoCli=1 Then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31') THEN -1               WHEN f.TipoCxc in ('81') THEN 0 END)*          Isnull((SELECT top 1 t.TGravable FROM SATAXCXC T WITH (NOLOCK)                   WHERE T.Codtaxs='IAL' And                       T.NroPpal=f.NroUnico),0)         else 0 end),    (Case when C.TipoCli=1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*       Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                 WHERE t.codtaxs='IAL' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli=1 then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31')  THEN -1               WHEN f.TipoCxc in ('81')  THEN 0 END)*        Isnull((SELECT top 1 t.MtoTax FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IAL' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31')  THEN -1                WHEN f.TipoCxc in ('81')  THEN 0 END)*         Isnull((SELECT top 1 T.TGravable FROM SATAXCXC T WITH (NOLOCK)                  WHERE T.Codtaxs='IVA' And                       T.NroPpal=f.NroUnico),0)     else 0 end),    (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IVA' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 T.MtoTax FROM SATAXCXC T WITH (NOLOCK)                  WHERE t.codtaxs='IVA' And                      t.nroppal=f.nrounico),0)     else 0 end),   (Case when C.TipoCli=1 Then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31') THEN -1               WHEN f.TipoCxc in ('81') THEN 0 END)*          Isnull((SELECT top 1 t.TGravable FROM SATAXCXC T WITH (NOLOCK)                   WHERE T.Codtaxs='IVA' And                       T.NroPpal=f.NroUnico),0)         else 0 end),    (Case when C.TipoCli=1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*       Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                 WHERE t.codtaxs='IVA' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli=1 then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31')  THEN -1               WHEN f.TipoCxc in ('81')  THEN 0 END)*        Isnull((SELECT top 1 t.MtoTax FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IVA' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31')  THEN -1                WHEN f.TipoCxc in ('81')  THEN 0 END)*         Isnull((SELECT top 1 T.TGravable FROM SATAXCXC T WITH (NOLOCK)                  WHERE T.Codtaxs='IVAAD' And                       T.NroPpal=f.NroUnico),0)     else 0 end),    (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IVAAD' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 T.MtoTax FROM SATAXCXC T WITH (NOLOCK)                  WHERE t.codtaxs='IVAAD' And                      t.nroppal=f.nrounico),0)     else 0 end),   (Case when C.TipoCli=1 Then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31') THEN -1               WHEN f.TipoCxc in ('81') THEN 0 END)*          Isnull((SELECT top 1 t.TGravable FROM SATAXCXC T WITH (NOLOCK)                   WHERE T.Codtaxs='IVAAD' And                       T.NroPpal=f.NroUnico),0)         else 0 end),    (Case when C.TipoCli=1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*       Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                 WHERE t.codtaxs='IVAAD' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli=1 then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31')  THEN -1               WHEN f.TipoCxc in ('81')  THEN 0 END)*        Isnull((SELECT top 1 t.MtoTax FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IVAAD' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31')  THEN -1                WHEN f.TipoCxc in ('81')  THEN 0 END)*         Isnull((SELECT top 1 T.TGravable FROM SATAXCXC T WITH (NOLOCK)                  WHERE T.Codtaxs='IVAT1' And                       T.NroPpal=f.NroUnico),0)     else 0 end),    (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IVAT1' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.TipoCli<>1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*         Isnull((SELECT top 1 T.MtoTax FROM SATAXCXC T WITH (NOLOCK)                  WHERE t.codtaxs='IVAT1' And                      t.nroppal=f.nrounico),0)     else 0 end),   (Case when C.TipoCli=1 Then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31') THEN -1               WHEN f.TipoCxc in ('81') THEN 0 END)*          Isnull((SELECT top 1 t.TGravable FROM SATAXCXC T WITH (NOLOCK)                   WHERE T.Codtaxs='IVAT1' And                       T.NroPpal=f.NroUnico),0)         else 0 end),    (Case when C.TipoCli=1 then          (CASE WHEN f.TipoCxc IN ('10','20') THEN 1                WHEN f.TipoCxc in ('31') THEN -1                WHEN f.TipoCxc in ('81') THEN 0 END)*       Isnull((SELECT top 1 t.Monto FROM SATAXCXC T WITH (NOLOCK)                 WHERE t.codtaxs='IVAT1' And                      t.nroppal=f.nrounico),0)    else 0 end),   (Case when C.tipocli=1 then         (CASE WHEN f.TipoCxc IN ('10','20') THEN 1               WHEN f.TipoCxc in ('31')  THEN -1               WHEN f.TipoCxc in ('81')  THEN 0 END)*        Isnull((SELECT top 1 t.MtoTax FROM SATAXCXC T WITH (NOLOCK)                   WHERE t.codtaxs='IVAT1' And                      t.nroppal=f.nrounico),0)    else 0 end),       F.RetenIVA*(CASE WHEN f.TipoCxc in ('10','20','81') THEN 1                        WHEN f.TipoCxc in ('31') THEN -1 END),        (CASE WHEN f.TipoCxc in ('10','20','81') THEN 1            WHEN f.TipoCxc in ('31') THEN -1 END)*       (case when F.RetenIVA<>0 Then            (F.MtoTax-F.RetenIVA)        Else 0 End) aS DifRetencion,       (CASE When f.TipoCxc In ('10','20','81') THEN 1            When f.TipoCxc in ('31')  THEN -1 END)*       (case When F.RetenIVA<>0 Then            Round(F.RetenIVA/F.MtoTax*100,2)        Else 0 End) AS PorctReten,      f.NumeroT As NroRetencion,      f.fechaR  As FechaRetencion,      F.NroUnico As NroUnico,      1 AS DBZFROM  SAACXC F  WITH (NOLOCK)  LEFT JOIN SACLIE C ON       C.CodClie=F.CodClieWHERE (f.TipoCxc IN ('10','20', '31', '81')) AND       (f.EsLibroI=1 and f.FROMTRAN=1))
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='VW_ADM_LIBROIVACOMPRAS' AND TYPE='V' )     DROP VIEW [DBO].VW_ADM_LIBROIVACOMPRAS;
GO
CREATE VIEW DBO.VW_ADM_LIBROIVACOMPRAS AS SELECT  '0' AS DBZ, C.CODSUCU,  C.TipoCom AS Tipo,  (CASE WHEN C.Tipocom='H' THEN '01-REG' ELSE '02-REG' END) AS TipoReg, C.FechaE AS FECHATRAN,  C.FechaI AS FECHACOMPRA,  C.FechaT,  C.ID3, C.CODPROV, C.Descrip, (Case When P.TipoPrv=1 Then (select RIF from saconf WITH (NOLOCK) ) else C.ID3 end) as ID3Ex,  (Case When P.TipoPrv=1 Then (select Descrip from saconf WITH (NOLOCK) ) else C.Descrip end) as DescripEx,  C.CodOper, (Case When C.Tipocom='H' Then 'FAC' Else    (CASE IsNull((SELECT CORRELUNC FROM SACONF),0) WHEN 1 THEN 'N/D' ELSE 'DEV' END) END) AS TIPODOC, C.NumeroD AS NUMERODOC,  (CASE WHEN C.TIPOCOM='I' THEN C.NumeroN ELSE NULL END) AS DOCAFECTADO,  C.NroCtrol,  C.NumeroP AS Planilla_Import, C.Signo*(CASE WHEN P.TIPOPRV=0 THEN (C.Monto+C.Fletes-(C.Descto1+C.Descto2)) ELSE 0 END) AS TOTALNACIONAL, C.Signo*(CASE WHEN P.TIPOPRV=1 THEN (C.Monto+C.Fletes-(C.Descto1+C.Descto2)) ELSE 0 END) AS TOTALIMPORTADO, C.Signo*(C.Monto+C.Fletes-(C.Descto1+C.Descto2)) AS TOTALCOMPRA,  C.Signo*(C.Monto+C.Fletes+C.MtoTax-(C.Descto1+C.Descto2)) AS TOTALCOMPRACONIVA,  C.Signo*C.MtoTax AS TOTALALICUOTA,  C.Signo*C.TExento AS MtoExento, C.Signo*(C.TGravable-C.TGravable*(C.DESCTO1+C.DESCTO2)/(case when C.Monto=0 then 1 else C.monto end)) As TotalGravable,  (Case when P.TipoPrv=0 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IAL') And (t.TIPOCOM=C.TIPOCOM) And    (t.codSucu=c.codsucu) And (t.codprov=c.codprov) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravable_IAL,  (Case when P.TipoPrv=0 Then C.Signo*IsNull((Select top 1 t.Monto   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IAL') And (t.codprov=c.codprov) And        (t.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Monto_IAL, (Case when P.TipoPrv=0 Then IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IAL') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Alicuota_IAL, (Case when P.TipoPrv=1 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IAL') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravableImpo_IAL,  (Case when P.TipoPrv=1 Then C.Signo*IsNull((Select Top 1 T.Monto                    From SATAXCOM T WITH (NOLOCK)                   Where (T.Codtaxs='IAL') And (t.codprov=c.codprov) And                         (T.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As MontoImpo_IAL, (Case when P.TipoPrv=1 Then       IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IAL') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As AlicuotaImpo_IAL, (Case when P.TipoPrv=0 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IVA') And (t.TIPOCOM=C.TIPOCOM) And    (t.codSucu=c.codsucu) And (t.codprov=c.codprov) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravable_IVA,  (Case when P.TipoPrv=0 Then C.Signo*IsNull((Select top 1 t.Monto   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVA') And (t.codprov=c.codprov) And        (t.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Monto_IVA, (Case when P.TipoPrv=0 Then IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVA') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Alicuota_IVA, (Case when P.TipoPrv=1 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IVA') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravableImpo_IVA,  (Case when P.TipoPrv=1 Then C.Signo*IsNull((Select Top 1 T.Monto                    From SATAXCOM T WITH (NOLOCK)                   Where (T.Codtaxs='IVA') And (t.codprov=c.codprov) And                         (T.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As MontoImpo_IVA, (Case when P.TipoPrv=1 Then       IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVA') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As AlicuotaImpo_IVA, (Case when P.TipoPrv=0 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IVAAD') And (t.TIPOCOM=C.TIPOCOM) And    (t.codSucu=c.codsucu) And (t.codprov=c.codprov) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravable_IVAAD,  (Case when P.TipoPrv=0 Then C.Signo*IsNull((Select top 1 t.Monto   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVAAD') And (t.codprov=c.codprov) And        (t.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Monto_IVAAD, (Case when P.TipoPrv=0 Then IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVAAD') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Alicuota_IVAAD, (Case when P.TipoPrv=1 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IVAAD') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravableImpo_IVAAD,  (Case when P.TipoPrv=1 Then C.Signo*IsNull((Select Top 1 T.Monto                    From SATAXCOM T WITH (NOLOCK)                   Where (T.Codtaxs='IVAAD') And (t.codprov=c.codprov) And                         (T.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As MontoImpo_IVAAD, (Case when P.TipoPrv=1 Then       IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVAAD') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As AlicuotaImpo_IVAAD, (Case when P.TipoPrv=0 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IVAT1') And (t.TIPOCOM=C.TIPOCOM) And    (t.codSucu=c.codsucu) And (t.codprov=c.codprov) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravable_IVAT1,  (Case when P.TipoPrv=0 Then C.Signo*IsNull((Select top 1 t.Monto   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVAT1') And (t.codprov=c.codprov) And        (t.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Monto_IVAT1, (Case when P.TipoPrv=0 Then IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVAT1') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As Alicuota_IVAT1, (Case when P.TipoPrv=1 Then  C.Signo*isnull((Select top 1 t.tgravable     From SATAXCOM T WITH (NOLOCK)     Where (t.codtaxs='IVAT1') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) AS MtoGravableImpo_IVAT1,  (Case when P.TipoPrv=1 Then C.Signo*IsNull((Select Top 1 T.Monto                    From SATAXCOM T WITH (NOLOCK)                   Where (T.Codtaxs='IVAT1') And (t.codprov=c.codprov) And                         (T.TIPOCOM=C.TIPOCOM) and (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As MontoImpo_IVAT1, (Case when P.TipoPrv=1 Then       IsNull((Select top 1 t.MtoTax   From  SATAXCOM t WITH (NOLOCK)   Where (t.codtaxs='IVAT1') And (t.TIPOCOM=C.TIPOCOM) And    (t.codprov=c.codprov) And (t.codSucu=c.codsucu) And (t.numerod=C.numerod)),0) Else 0 End) As AlicuotaImpo_IVAT1, C.Signo*C.RetenIVA AS RetencionIVA, (Case when C.MtoTax<>C.RetenIVA Then C.Signo*(C.MtoTax-C.RetenIVA)  Else 0 End) As DifRetencion, (Case when C.MtoTax<>0 Then C.Signo*Round(C.RetenIVA/C.MtoTax*100,2)   Else 0 End) As PorctReten, C.NUMEROR AS NRORETENCION, C.fechaR  As FechaRetencion, C.NroUnico As NroUnicoFROM SACOMP C WITH (NOLOCK)  LEFT JOIN SAPROV P ON   C.CodProv = P.CodProvWHERE (C.TipoCom IN ('H', 'I'))UNION ALL(SELECT    '1' AS DBZ,   T.CODSUCU,   T.TipoCxP AS Tipo,    (CASE WHEN T.TipoCxP='10' THEN '01-REG'          WHEN T.TipoCxP='30' THEN '03-REG'          WHEN T.TipoCxP='81' THEN '03-REG'          WHEN T.TipoCxP='82' THEN '03-REG'          WHEN SUBSTRING(T.TipoCxP,1,1)='2' THEN '02-REG' END) AS Reg,   T.FechaE,     T.FechaI,    T.FechaT,    T.ID3,    P.CODPROV,    T.Descrip,    (Case when P.TipoPrv=1 Then (Select RIF     From SACONF WITH (NOLOCK)) ELSE T.ID3 END) AS ID3Ex,    (Case when P.TipoPrv=1 Then (Select Descrip From SACONF WITH (NOLOCK)) ELSE T.Descrip END) AS DescripEx,    T.CodOper,   (CASE WHEN T.TipoCxP='10' THEN 'FAC'          WHEN T.TipoCxP='30' THEN 'N/C'          WHEN T.TipoCxP='81' THEN 'RET'          WHEN T.TipoCxP='82' THEN 'RET'          WHEN T.TipoCxP='21' THEN 'N/D' END) AS TIPODOC,   T.NUMEROD,   T.NumeroN,    T.NroCtrol,    Null As Planilla_Import,   T.Monto*(CASE WHEN P.TipoPrv=0 THEN                      (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)             ELSE 0 END) AS TotalNac,    T.Monto*(CASE WHEN P.TipoPrv = 1 THEN                      (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)             ELSE 0 END) AS TotalExt,    T.MontoNETO*(CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END) AS TOTALCOMPRA,   (T.MontoNeto+T.MtoTax)*(CASE WHEN T.TipoCxP in ('10','30') THEN 1                                 WHEN T.TipoCxP in ('81')        THEN 0                                 ELSE - 1 END) AS TOTALCOMPRACONIVA,   T.MtoTax*(CASE WHEN T.TipoCxP in ('10','30') THEN 1                   WHEN T.TipoCxP in ('81') THEN 0                   ELSE - 1 END) AS TOTALALICUOTA,    (CASE WHEN T.TipoCxP in ('10','30') THEN 1          WHEN T.TipoCxP in ('81') THEN 0          ELSE - 1 END)*   ((CASE WHEN T.MontoNeto=0 THEN               T.MONTO-(CASE WHEN T.ORGTAX=0 THEN T.MTOTAX ELSE T.OrgTax END)                          ELSE T.MontoNETO END)-T.BaseImpo),   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*T.BaseImpo, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IAL') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravable_IAL,  (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IAL') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As Monto_IAL, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IAL') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As Alicuota_IAL, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IAL') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravableImpo_IAL,  (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IAL') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As MontoImpo_IAL, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IAL') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As AlicuotaImpo_IAL, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IVA') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravable_IVA,  (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVA') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As Monto_IVA, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVA') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As Alicuota_IVA, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IVA') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravableImpo_IVA,  (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVA') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As MontoImpo_IVA, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVA') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As AlicuotaImpo_IVA, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IVAAD') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravable_IVAAD,  (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAAD') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As Monto_IVAAD, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAAD') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As Alicuota_IVAAD, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IVAAD') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravableImpo_IVAAD,  (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAAD') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As MontoImpo_IVAAD, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAAD') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As AlicuotaImpo_IVAAD, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IVAT1') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravable_IVAT1,  (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAT1') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As Monto_IVAT1, (Case when P.TipoPrv=0 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAT1') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As Alicuota_IVAT1, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.tgravable        From SATAXCXP TP WITH (NOLOCK)        Where (tp.codtaxs='IVAT1') And    (tp.nroppal=T.nrounico)),0) Else 0 End) AS MtoGravableImpo_IVAT1,  (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.Monto              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAT1') And   (tp.nroppal=T.nrounico)),0) Else 0 End) As MontoImpo_IVAT1, (Case when P.TipoPrv=1 Then   (CASE WHEN T.TipoCxP in ('10','30') THEN 1 ELSE - 1 END)*    IsNull((Select top 1 tP.MtoTax              From  SATAXCXP tP WITH (NOLOCK)              Where (tP.codtaxs='IVAT1') And    (tp.nroppal=T.nrounico)),0) Else 0 End) As AlicuotaImpo_IVAT1, (CASE WHEN T.TipoCxP in ('10','30','81') THEN 1 ELSE - 1 END)*T.RetenIVA AS RetencionIVA, (CASE when T.RetenIVA<>0 Then      (CASE WHEN T.TipoCxP in ('10','30','81') THEN 1 ELSE - 1 END)*      (T.MtoTax-T.RetenIVA)   Else 0 End) As DifRetencion, (Case when T.MtoTax<>0 Then     (CASE WHEN T.TipoCxP in ('10','30','81') THEN 1 ELSE - 1 END)*     Round(T.RetenIVA/T.MtoTax*100,2)  Else 0 End) As PorctReten, (CASE WHEN T.TipoCxP IN ('10','30') THEN             (SELECT TOP 1 NUMEROD FROM SAACXP WHERE NROREGI=T.NROUNICO AND TIPOCXP='81')       WHEN T.TipoCxP='81' THEN T.NUMEROD   ELSE NULL END) AS NRORETENCION, (CASE WHEN T.TipoCxP IN ('10','30') THEN T.fechaR        WHEN T.TipoCxP='81' THEN T.FECHAE   ELSE NULL END) AS FechaRetencion, T.NroUnico As NroUnico FROM SAACXP T WITH (NOLOCK)  LEFT JOIN SAPROV P ON   (T.CodProv = P.CodProv) WHERE (T.FROMTRAN = 1) AND (T.EsLibroI = 1) AND        (T.TipoCxP IN ('10','21','30','81','82')))
GO
