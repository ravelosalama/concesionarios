-- ******************* SAINT ANNUAL ENTERPRISE AUTOMOTRIZ **********************-- ******************* PROCEDURE PARA VERSION 9039  ****************************-- SCRIPTS REALIZADO POR: JOSE RAVELO / ENERO 2019 --         TESTEADO: POR: JOSE RAVELO / ENERO 2019--         EJECUTADO: -- Corrige y genera SP y Fn para subsanar error en actualización 9037 y 9038-- *****************************************************************************IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SP_ADM_DROPCONSTRAINS' AND TYPE='P' )     DROP PROCEDURE [DBO].SP_ADM_DROPCONSTRAINS;
GO
CREATE PROCEDURE [DBO].SP_ADM_DROPCONSTRAINS( @parNameT sysname, @parField sysname ) WITH ENCRYPTION AS DECLARE @ID INT, @Name sysname; If Exists(Select sc.Name From SysObjects so, SysColumns sc Where so.Id=sc.Id And so.XType='U' And so.Name=@parNameT And sc.Name=@parField) begin      Select @ID=sc.cdefault From SysObjects so, SysColumns sc      Where so.Id=sc.Id And so.XType='U' And so.Name=@parNameT And sc.Name=@parField      if @ID <> 0 begin        Select @Name=Name From SysObjects Where Id=@ID        exec('alter table '+@parNameT+' drop CONSTRAINT '+@Name)      end  end
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_SALDOACTUALCXC' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_SALDOACTUALCXC;
GO
CREATE FUNCTION FN_ADM_SALDOACTUALCXC (@CodClie as Varchar(15), @Fecha as Datetime)
RETURNS Decimal(28,4) 
WITH ENCRYPTION AS
Begin
  return
   (select sum(Case When substring(tipocxc,1,1) in  ('3','4','8') Then -1*monto
                    when tipocxc in ('10','60','70','20') Then monto
                    Else 0 end) as Saldo
      From saacxc WITH (NOLOCK) 
     where CodClie = @CodClie and Fechae <= @Fecha)
end
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_SALDOACTUALCXP' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_SALDOACTUALCXP;
GO
CREATE FUNCTION FN_ADM_SALDOACTUALCXP (@CODPROV as Varchar(15), @Fecha as Datetime)
RETURNS Decimal(28,4) 
WITH ENCRYPTION AS
Begin
  Return
   (select sum(Case When substring(tipoCXP,1,1) In ('2','4','8') Then -1*monto
                    When tipoCXP In ('10','60','70','30','31') Then monto
                    Else 0 end) as Saldo
      From SAACXP WITH (NOLOCK) 
     where CODPROV = @CODPROV and Fechae <= @Fecha)
end
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_CALCULARPAGOSCXP' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_CALCULARPAGOSCXP;
GO
CREATE FUNCTION [DBO].FN_ADM_CALCULARPAGOSCXP(@NROUNICO INT, @FECHAE DATETIME) RETURNS DECIMAL(28,3) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALPAGOS DECIMAL(28,3);   Select @TOTALPAGOS=SUM((case when SubString(p.TipoCxp,1,1) IN ('1','3','6','7') Then DP.Monto               when SubString(p.TipoCxp,1,1) IN ('2','4','5','8') Then DP.Monto*-1          End))   from saacxp P WITH (NOLOCK)        inner join sapagcxp dp on dp.NroPpal = p.NroUnico   Where dp.NroRegi = @NROUNICO And        (SUBSTRING(CONVERT(VARCHAR,p.FechaE,120),1,10) <= SUBSTRING(CONVERT(VARCHAR,@FECHAE,120),1,10))   GROUP BY P.CodProv, dp.NroRegi   RETURN ISNULL(@TOTALPAGOS,0.00);END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_CALCULARADELCXP' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_CALCULARADELCXP;
GO
CREATE FUNCTION [DBO].FN_ADM_CALCULARADELCXP(@CODIGO VARCHAR(20), @FECHAE DATETIME) RETURNS DECIMAL(28,3) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALADEL DECIMAL(28,3), @TOTALADELA DECIMAL(28,3);   Select @TOTALADEL = ISNULL(SUM(P.CancelA),0.00)   from saacxp P WITH (NOLOCK)   Where p.CancelA>0 And p.CodProv = @CODIGO And        (SUBSTRING(CONVERT(VARCHAR,p.FechaE,120),1,10)<=SUBSTRING(CONVERT(VARCHAR,@FECHAE,120),1,10))   Select @TOTALADELA = ISNULL(SUM(P.Monto),0.00)   from saacxp P WITH (NOLOCK)   Where p.CodProv = @CODIGO And         (SUBSTRING(CONVERT(VARCHAR,p.FechaE,120),1,10) <= SUBSTRING(CONVERT(VARCHAR,@FECHAE,120),1,10))         And p.TipoCxp Like '3%' And CHARINDEX('5',p.TipoCxp) <> 0   RETURN ISNULL((@TOTALADEL+@TOTALADELA)*(-1),0.00);END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_CALCULARPAGOSCXC' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_CALCULARPAGOSCXC;
GO
CREATE FUNCTION [DBO].FN_ADM_CALCULARPAGOSCXC(@NROUNICO INT, @FECHAE DATETIME) RETURNS DECIMAL(28,3) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALPAGOS DECIMAL(28,3);  Select @TOTALPAGOS = SUM((case when SubString(p.TipoCxc,1,1) IN ('1','2','6','7') Then DP.Monto               when SubString(p.TipoCxc,1,1) IN ('3','4','5','8') Then DP.Monto*-1          End))  from saacxc P WITH (NOLOCK)  inner join sapagcxc dp on dp.NroPpal = p.NroUnico        Where dp.NroRegi = @NROUNICO And              (SUBSTRING(CONVERT(VARCHAR,p.FechaE,120),1,10) <= SUBSTRING(CONVERT(VARCHAR,@FECHAE,120),1,10))  Group By P.CodClie, dp.NroRegi   RETURN ISNULL(@TOTALPAGOS,0.00);END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_CALCULARADELCXC' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_CALCULARADELCXC;
GO
CREATE FUNCTION [DBO].FN_ADM_CALCULARADELCXC(@CODIGO VARCHAR(20), @FECHAE DATETIME) RETURNS DECIMAL(28,3) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALADEL DECIMAL(28,3), @TOTALADELA DECIMAL(28,3);   Select @TOTALADEL = ISNULL(SUM(P.CancelA),0.00)   from saacxc P  WITH (NOLOCK)   Where p.CancelA > 0 And p.CodClie = @CODIGO And              (SUBSTRING(CONVERT(VARCHAR,p.FechaE,120),1,10) <= SUBSTRING(CONVERT(VARCHAR,@FECHAE,120),1,10))   Select @TOTALADELA = ISNULL(SUM(P.Monto),0.00)   from saacxc P  WITH (NOLOCK)   Where p.CodClie = @CODIGO And         (SUBSTRING(CONVERT(VARCHAR,p.FechaE,120),1,10) <= SUBSTRING(CONVERT(VARCHAR,@FECHAE,120),1,10))          And p.TipoCxc Like '2%' And CHARINDEX('5',p.TipoCxc) <> 0   RETURN ISNULL((@TOTALADEL+@TOTALADELA)*(-1),0.00);END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_EXISTPRODUC' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_EXISTPRODUC;
GO
CREATE FUNCTION [DBO].FN_ADM_EXISTPRODUC(@CODIGOI VARCHAR(20), @CODUBIC VARCHAR(20), @ESUNID INT) RETURNS DECIMAL(28,3) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALUBIC DECIMAL(28,3);   SELECT @TOTALUBIC=(CASE @ESUNID WHEN 0 THEN E.EXISTEN                       ELSE P.CANTEMPAQ*E.EXISTEN+E.EXUNIDAD END)     FROM SAEXIS E, SAPROD P  WITH (NOLOCK)     WHERE P.CODPROD=E.CODPROD AND           E.CODPROD=@CODIGOI AND E.CODUBIC=@CODUBIC;   RETURN ISNULL(@TOTALUBIC,0.00);END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_PRICETAXPRD' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_PRICETAXPRD;
GO
CREATE FUNCTION dbo.FN_ADM_PRICETAXPRD(@CODIGOI VARCHAR(20), @PRECIO DECIMAL(28,5),  @CANTIDAD DECIMAL(28,5), @ESUNID SMALLINT) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALTAX DECIMAL(28,5);   SET @TOTALTAX=0;   SELECT @TOTALTAX=((Select ISNULL(Sum(Monto),0.00)*(@CANTIDAD*@PRECIO/100)  FROM VW_ADM_TAXINVENT WITH (NOLOCK)  WHERE CodProd=@CODIGOI and EsPorct=1 AND ESTAXVENTA=1 AND ESRETEN=0)+           (Select ISNULL(Sum((CASE @ESUNID WHEN 0 THEN @CANTIDAD*TX.MONTO  ELSE (CASE WHEN PR.CANTEMPAQ>0 THEN @CANTIDAD*TX.Monto/PR.CANTEMPAQ         ELSE @CANTIDAD*TX.Monto END) END)),0.00)  from VW_ADM_TAXINVENT TX, SAPROD PR  WITH (NOLOCK)  where PR.CODPROD=TX.CODPROD AND TX.CodProd=@CODIGOI AND TX.EsPorct=0 AND TX.ESTAXVENTA=1 AND TX.ESRETEN=0));  RETURN @PRECIO+@TOTALTAX; END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_PRICETAXSRV' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_PRICETAXSRV;
GO
CREATE FUNCTION dbo.FN_ADM_PRICETAXSRV(@CODIGOI VARCHAR(20),@PRECIO DECIMAL(28,5),@CANTIDAD DECIMAL(28,5)) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALTAX DECIMAL(28,5);  SET @TOTALTAX=0;  SELECT @TOTALTAX=((SELECT ISNULL(Sum(Monto),0.00)*(@CANTIDAD*@PRECIO/100)    FROM VW_ADM_TAXSERVI  WITH (NOLOCK)    WHERE CODSERV=@CODIGOI AND ESPORCT=1 AND ESTAXVENTA=1 AND ESRETEN=0) +         (SELECT ISNULL(SUM(@CANTIDAD*Monto),0.00)           FROM VW_ADM_TAXSERVI WITH (NOLOCK)           WHERE CODSERV=@CODIGOI AND ESPORCT=0 AND ESTAXVENTA=1 AND ESRETEN=0));   RETURN @PRECIO+@TOTALTAX; END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_TAXPRICE' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_TAXPRICE;
GO
CREATE FUNCTION [DBO].FN_ADM_TAXPRICE(@CODIGOI VARCHAR(20), @PRECIO DECIMAL(28,5), @CANTIDAD DECIMAL(28,5),  @ESSERV INT, @ESUNID INT) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN   DECLARE @TOTALTAX DECIMAL(28,5);   SET @TOTALTAX=0;   If @ESSERV=0      SELECT @TOTALTAX= dbo.FN_ADM_PRICETAXPRD(@CODIGOI,@PRECIO,@CANTIDAD,@ESUNID)-@PRECIO   ELSE      SELECT @TOTALTAX= dbo.FN_ADM_PRICETAXSRV(@CODIGOI,@PRECIO,@CANTIDAD)-@PRECIO   RETURN @TOTALTAX;END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_COSTOTAXPRD' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_COSTOTAXPRD;
GO
CREATE FUNCTION dbo.FN_ADM_COSTOTAXPRD(@CODIGOI VARCHAR(20), @PRECIO DECIMAL(28,5),  @CANTIDAD DECIMAL(28,5), @ESUNID SMALLINT) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALTAX DECIMAL(28,5);   SET @TOTALTAX=0;   SELECT @TOTALTAX=((Select ISNULL(Sum(Monto),0.00)*(@CANTIDAD*@PRECIO/100)  FROM VW_ADM_TAXINVENT WITH (NOLOCK)  WHERE CodProd=@CODIGOI and EsPorct=1 AND ESTAXCOMPRA=1 AND ESRETEN=0)+           (Select ISNULL(Sum((CASE @ESUNID WHEN 0 THEN @CANTIDAD*TX.MONTO  ELSE (CASE WHEN PR.CANTEMPAQ>0 THEN @CANTIDAD*TX.Monto/PR.CANTEMPAQ         ELSE @CANTIDAD*TX.Monto END) END)),0.00)  from VW_ADM_TAXINVENT TX, SAPROD PR  WITH (NOLOCK)  where PR.CODPROD=TX.CODPROD AND TX.CodProd=@CODIGOI AND TX.EsPorct=0 AND TX.ESTAXCOMPRA=1 AND TX.ESRETEN=0));  RETURN @PRECIO+@TOTALTAX; END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_COSTOTAXSRV' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_COSTOTAXSRV;
GO
CREATE FUNCTION dbo.FN_ADM_COSTOTAXSRV(@CODIGOI VARCHAR(20),@PRECIO DECIMAL(28,5), @CANTIDAD DECIMAL(28,5) ) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN  DECLARE @TOTALTAX DECIMAL(28,5);  SET @TOTALTAX=0;  SELECT @TOTALTAX=((SELECT ISNULL(Sum(Monto),0.00)*(@CANTIDAD*@PRECIO/100)    FROM VW_ADM_TAXSERVI  WITH (NOLOCK)    WHERE CODSERV=@CODIGOI AND ESPORCT=1 AND ESTAXCOMPRA=1 AND ESRETEN=0) +         (SELECT ISNULL(SUM(@CANTIDAD*Monto),0.00)           FROM VW_ADM_TAXSERVI WITH (NOLOCK)           WHERE CODSERV=@CODIGOI AND ESPORCT=0 AND ESTAXCOMPRA=1 AND ESRETEN=0));   RETURN @PRECIO+@TOTALTAX; END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_TAXCOSTO' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_TAXCOSTO;
GO
CREATE FUNCTION [DBO].FN_ADM_TAXCOSTO(@CODIGOI VARCHAR(20), @PRECIO DECIMAL(28,5), @CANTIDAD DECIMAL(28,5),  @ESSERV INT, @ESUNID INT) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN   DECLARE @TOTALTAX DECIMAL(28,5);   SET @TOTALTAX=0;   If @ESSERV=0      SELECT @TOTALTAX= dbo.FN_ADM_COSTOTAXPRD(@CODIGOI,@PRECIO,@CANTIDAD,@ESUNID)-@PRECIO   ELSE      SELECT @TOTALTAX= dbo.FN_ADM_COSTOTAXSRV(@CODIGOI,@PRECIO,@CANTIDAD)-@PRECIO   RETURN @TOTALTAX;END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_PRICEBASE' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_PRICEBASE;
GO
CREATE FUNCTION dbo.FN_ADM_PRICEBASE(@CODIGOI VARCHAR(20),@PRECIO DECIMAL(28,5),  @ESSERV INT, @ESUNID INT) RETURNS DECIMAL(28,5) WITH ENCRYPTION AS BEGIN  DECLARE     @MONTO DECIMAL(28,5),     @PORCT DECIMAL(28,5);   SET @MONTO=0;   SET @PORCT=0;   IF @ESSERV=0      SELECT @PORCT=ISNULL((SELECT SUM(MONTO/100) FROM VW_ADM_TAXINVENT WITH (NOLOCK)                             WHERE CODPROD=@CODIGOI AND ESPORCT=1 AND ESRETEN=0),0),             @MONTO=ISNULL((SELECT SUM((CASE @ESUNID WHEN 0 THEN TX.MONTO                                         ELSE TX.Monto/PR.CANTEMPAQ END))                             FROM VW_ADM_TAXINVENT TX, SAPROD PR WITH (NOLOCK)                             WHERE PR.CODPROD=TX.CODPROD AND                                   TX.CodProd=@CODIGOI AND TX.EsPorct=0 AND TX.ESRETEN=0),0)   ELSE      SELECT @PORCT=ISNULL((SELECT SUM(MONTO/100) FROM VW_ADM_TAXSERVI WITH (NOLOCK)                             WHERE CODSERV=@CODIGOI AND ESPORCT=1 AND ESRETEN=0),0),             @MONTO=ISNULL((SELECT SUM(MONTO) FROM VW_ADM_TAXSERVI WITH (NOLOCK)                             WHERE CODSERV=@CODIGOI AND EsPorct=0 AND ESRETEN=0),0);  RETURN (@PRECIO-@MONTO)/(1+@PORCT);END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_PRICEFINAL' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_PRICEFINAL;
GO
CREATE FUNCTION dbo.FN_ADM_PRICEFINAL(@CODIGOI VARCHAR(20), @CODIGOC VARCHAR(20),  @CODIGOV VARCHAR(20), @MONTOBASE DECIMAL(28,5),  @CANTIDAD  DECIMAL(28,5),  @FECHAE VARCHAR(30)) RETURNS VARCHAR(30) WITH ENCRYPTION AS BEGIN  DECLARE @TOTAL   DECIMAL(28,5),          @TOTALC  DECIMAL(28,5),          @MONTOC  DECIMAL(28,5),          @CODCONV VARCHAR(20),          @NUMTEMP VARCHAR(30),          @SIGNO  INT,          @ESCONV SMALLINT,          @ESOFER SMALLINT,          @ESFIJO INT,          @MEDIDA INT,          @CODINST VARCHAR(30);   SET @ESCONV=0;  SET @ESOFER=0;  SET @ESFIJO=0;  SET @MEDIDA=0;  SET @SIGNO=-1;  SET @TOTAL=@MONTOBASE;  SET @CODCONV=@CODIGOV;  IF @CODCONV<>'' BEGIN      IF EXISTS(SELECT CV.CODCONV                  FROM SACONV CV WITH (NOLOCK)                  WHERE (CV.CODCONV=@CODIGOV) AND (CV.TIPOCNV=0) AND (CV.ACTIVO=1) AND                 (SUBSTRING(CONVERT(VARCHAR,CV.FECHAE,120),1,10)<=SUBSTRING(@FECHAE,1,10)) AND                 (SUBSTRING(@FECHAE,1,10)<=SUBSTRING(CONVERT(VARCHAR,CV.FECHAV,120),1,10))) BEGIN        SELECT @ESFIJO=CV.ESFIJO, @CODCONV=CV.CODCONV           FROM SACONV CV WITH (NOLOCK)         WHERE (CV.CODCONV=@CODIGOV) AND (CV.TIPOCNV=0) AND (CV.ACTIVO=1) AND                (SUBSTRING(CONVERT(VARCHAR,CV.FECHAE,120),1,10)<=SUBSTRING(@FECHAE,1,10)) AND                (SUBSTRING(@FECHAE,1,10)<=SUBSTRING(CONVERT(VARCHAR,CV.FECHAV,120),1,10));       END     ELSE SET @CODCONV='NULL'  END;  SELECT @CODINST=ISNULL((SELECT CODINST FROM SAPROD WITH (NOLOCK) WHERE CODPROD=@CODIGOI                    UNION ALL (SELECT CODINST FROM SASERV WITH (NOLOCK) WHERE CODSERV=@CODIGOI)),0);  IF @CODCONV<>'NULL' BEGIN       DECLARE CUR_CALCONV CURSOR FOR        SELECT MEDIDA, ISNULL(CASE WHEN MEDIDA IN (0,2) THEN MONTO/100.00                                 ELSE MONTO END,0)       FROM SAITCV WITH (NOLOCK)        WHERE CodConv=@CODCONV AND              (CodItem=@CODIGOI OR (TipoCnv In (2,3) And CodItem=CONVERT(VARCHAR,@CODINST))) AND              ((DESDE<=@CANTIDAD) AND (@CANTIDAD<=HASTA) OR (DESDE=0 and HASTA=0))        ORDER BY TIPOCNV;      OPEN CUR_CALCONV;      FETCH NEXT FROM CUR_CALCONV INTO @MEDIDA, @MONTOC;     SET @TOTALC = @MONTOBASE;     WHILE @@FETCH_STATUS = 0 BEGIN        SET @SIGNO=-1;       SET @ESCONV=1;       IF @MEDIDA=2 SET @SIGNO=1;        IF @MEDIDA IN (0,2)           SET @TOTALC=@TOTALC+(@TOTALC*@MONTOC)*@SIGNO        ELSE           SET @TOTALC=@MONTOC;        FETCH NEXT FROM CUR_CALCONV INTO @MEDIDA, @MONTOC;       END;      CLOSE CUR_CALCONV;      DEALLOCATE CUR_CALCONV;      SET @TOTAL=@TOTALC;     END;  SELECT @ESOFER=ISNULL((SELECT ESOFERTA FROM SAPROD WITH (NOLOCK) WHERE CODPROD=@CODIGOI                   UNION ALL (SELECT 1 FROM SASERV  WITH (NOLOCK) WHERE CODSERV=@CODIGOI)),0);  IF (@ESOFER=1) BEGIN      SET @ESOFER=0;      IF (@ESFIJO=0) BEGIN         SELECT TOP 1 @MEDIDA=I.MEDIDA, @ESCONV=0, @ESOFER=1,                @TOTAL=ISNULL(CASE WHEN I.MEDIDA=0 THEN @MONTOBASE*I.MONTO/100.00 ELSE I.MONTO END,0)          FROM SAOFER O  WITH (NOLOCK)            INNER JOIN SAITEO I ON (I.NUMEROD=O.NUMEROD)            LEFT JOIN SACLIOFE C ON (C.NUMEROD=O.NUMEROD)           WHERE (O.ACTIVO=1) AND                 (CONVERT(VARCHAR,O.FECHAE,120)<=@FECHAE AND                  @FECHAE<=CONVERT(VARCHAR,O.FECHAV,120)) AND                 SUBSTRING(O.Frecuencia,DatePart(DW,@FECHAE),1)='1' AND                 (((I.DESDE<=@CANTIDAD) AND (@CANTIDAD<=I.HASTA)) OR (I.DESDE=I.HASTA)) AND                 ((I.CODITEM=@CODIGOI) OR (I.TipoOfe In (2,3) And I.CodItem=CONVERT(VARCHAR,@CODINST))) AND                ((C.CODCLIE=@CODIGOC) OR (O.TIPOOFE=1));      IF @MEDIDA=0 AND @ESOFER=1          SET @TOTAL=@MONTOBASE+@SIGNO*@TOTAL;     END;  END;  SET @NUMTEMP=CONVERT(VARCHAR,@ESCONV)+CONVERT(VARCHAR,@ESOFER)+               CONVERT(VARCHAR,@MEDIDA)+CONVERT(VARCHAR,@TOTAL);  RETURN @NUMTEMP;END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_DESCTOCONVENIO' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_DESCTOCONVENIO;
GO
 CREATE FUNCTION dbo.FN_ADM_DESCTOCONVENIO     (@CODIGOC VARCHAR(20),       @MONTOBASE DECIMAL(28,3),       @CANTIDAD DECIMAL(28,3),       @FECHAE VARCHAR(30)) RETURNS VARCHAR(30) WITH ENCRYPTION AS BEGIN DECLARE    @TOTAL   DECIMAL(28,3),   @TOTALC  DECIMAL(28,3),   @MONTOC  DECIMAL(28,3),   @CODCONV VARCHAR(20),   @NUMTEMP VARCHAR(30),   @SIGNO   INT,   @TIPOCNV  SMALLINT,   @ESCONV  SMALLINT,   @MEDIDA  INT,   @PERIODO VARCHAR(6),   @CODINST VARCHAR(30); SET @ESCONV=0; SET @MEDIDA=0; SET @SIGNO=-1; SET @TOTAL=@MONTOBASE; SET @PERIODO=SUBSTRING(@FECHAE,1,4)+SUBSTRING(@FECHAE,6,2); SELECT  @CODCONV=ISNULL(CV.CODCONV,''),         @TIPOCNV=ISNULL(CV.TIPOCNV,0)  FROM  SACONV CV WITH (NOLOCK)    INNER JOIN SACLIE CL ON    CL.CODCONV=CV.CODCONV AND (CL.CODCLIE=@CODIGOC)  WHERE (CV.TIPOCNV IN (1,2,3)) AND        (CV.FechaE<=CONVERT(DATETIME,@FECHAE)) AND        (CONVERT(DATETIME,@FECHAE)<=CV.FechaV); IF @CODCONV<>''     BEGIN     IF @TIPOCNV=2        SET @CANTIDAD=ISNULL((SELECT SUM(SIGNO*MONTO)+@MONTOBASE                             FROM SAFACT WITH (NOLOCK)                              WHERE (CODCLIE=@CODIGOC) AND                                   (SUBSTRING(@FECHAE,1,8)+'01'<=                          SUBSTRING(CONVERT(VARCHAR,FECHAE,120),1,10))),@MONTOBASE);     IF @TIPOCNV=3        SET @CANTIDAD=ISNULL((SELECT VALORPTOS+@MONTOBASE                             FROM SAPTOSCLIENTE WITH (NOLOCK)                              WHERE (CODCLIE=@CODIGOC) AND                                   (PERIODO=@PERIODO)),@MONTOBASE);     DECLARE CUR_CALCONV CURSOR FOR      SELECT MEDIDA, ISNULL(CASE WHEN MEDIDA IN (0,2) THEN MONTO/100.00 ELSE MONTO END,0)       FROM SAITCV WITH (NOLOCK)        WHERE CodConv=@CODCONV AND           ((DESDE<=@CANTIDAD) AND (@CANTIDAD<=HASTA) OR (DESDE=0 and HASTA=0))       ORDER BY TIPOCNV    OPEN CUR_CALCONV;    FETCH NEXT FROM CUR_CALCONV INTO @MEDIDA, @MONTOC;    SET @TOTALC = @MONTOBASE;    WHILE @@FETCH_STATUS = 0 BEGIN     SET @SIGNO=-1;     IF @MEDIDA=2 SET @SIGNO=1;     IF @MEDIDA IN (0,2)        SET @TOTALC=@TOTALC+(@TOTALC*@MONTOC)*@SIGNO     ELSE        SET @TOTALC=@MONTOC;     FETCH NEXT FROM CUR_CALCONV INTO @MEDIDA, @MONTOC;    END;    CLOSE CUR_CALCONV;    DEALLOCATE CUR_CALCONV;    IF @TOTALC<>@MONTOBASE SET @ESCONV=1;    SET @TOTAL=@TOTALC;   END;SET @NUMTEMP=CONVERT(VARCHAR,@ESCONV)+CONVERT(VARCHAR,@MEDIDA)+CONVERT(VARCHAR,@TOTAL);RETURN @NUMTEMP;END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_RETENCIONES' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_RETENCIONES;
GO
 CREATE FUNCTION dbo.FN_ADM_RETENCIONES     (@CODTAXS VARCHAR(10),       @TIPORET INT,       @MTOBASE DECIMAL(28,3)) RETURNS VARCHAR(30) WITH ENCRYPTION AS BEGIN Declare   @NUMTEMP VARCHAR(30),   @porct   decimal(28,4),   @totret  Decimal(28,4),   @sustraendo  decimal(28,4); SET @sustraendo=isnull((SELECT (CASE WHEN @MTOBASE>MontoMax THEN SUSTRAENDO ELSE 0 END)                    FROM SATAXES                   WHERE CODTAXS=@CODTAXS AND ESRETEN=1),0); SET @PORCT=ISNULL((Select top 1 r.monto                       From sargoret r WITH (NOLOCK)                     Where (@MtoBase>=R.Desde And @MtoBase<=R.Hasta) And                            R.CodTaxs=@CodTaxs And R.TipoRgo=@TIPORET),0);  SET @TOTRET=@PORCT*@MTOBASE/100-@SUSTRAENDO SET @NUMTEMP=CONVERT(VARCHAR,@PORCT)+'|'+CONVERT(VARCHAR,@TOTRET); RETURN @NUMTEMP;END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_PRODxINSTA' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_PRODxINSTA;
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ADM_SERVxINSTA' AND TYPE='FN')     DROP FUNCTION [DBO].FN_ADM_SERVxINSTA;
GO
